<!DOCTYPE html>
<html class="no-js" lang="zxx">
  <!-- Mirrored from htmldemo.net/floda/floda/product-details.html by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 13 Aug 2025 01:29:25 GMT -->
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="meta description" />
    <title>Floda - Flower eCommerce Bootstrap 5 Template</title>

    <!--=== Favicon ===-->
    <link
      rel="shortcut icon"
      href="../../img/favicon.ico"
      type="image/x-icon"
    />

    <!-- Google fonts include -->
    <link
      href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,500,500i,700,900%7CYesteryear"
      rel="stylesheet"
    />

    <!-- All Vendor & plugins CSS include -->
    <link href="../../css/vendor.css" rel="stylesheet" />
    <!-- Main Style CSS -->
    <link href="../../css/style.css" rel="stylesheet" />
    <!-- Cart CSS for toast notifications -->
    <link href="../../css/cart.css" rel="stylesheet" />

    <style>
      /* Quantity controls styling */
      .pro-qty {
        display: flex;
        align-items: center;
        border: 1px solid #ddd;
        border-radius: 4px;
        overflow: hidden;
        width: 120px;
        background: white;
        position: relative;
        z-index: 10;
      }

      .qty-btn {
        background: #f8f9fa;
        border: none;
        padding: 8px 12px;
        cursor: pointer;
        transition: background-color 0.3s;
        flex: 0 0 40px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: bold;
        color: #333;
        position: relative;
        z-index: 11;
      }

      .qty-btn:hover {
        background: #e9ecef;
      }

      .qty-btn:active {
        background: #dee2e6;
      }

      #productQuantity {
        border: none;
        text-align: center;
        width: 100%;
        height: 40px;
        padding: 8px;
        outline: none;
        background: white;
        font-size: 14px;
        font-weight: 500;
        color: #333;
        position: relative;
        z-index: 12;
      }

      #productQuantity:focus {
        border: 2px solid #ac3b61;
        box-shadow: 0 0 5px rgba(172, 59, 97, 0.3);
      }

      /* Hide number input arrows (spinners) */
      /* Chrome, Safari, Edge, Opera */
      #productQuantity::-webkit-outer-spin-button,
      #productQuantity::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      /* Firefox */
      #productQuantity[type="number"] {
        -moz-appearance: textfield;
      }

      /* Ensure no duplicate buttons */
      .pro-qty button:not(:first-of-type):not(:last-of-type) {
        display: none !important;
      }

      .pro-qty button:first-of-type {
        order: 1;
      }

      .pro-qty button:last-of-type {
        order: 3;
      }

      #productQuantity {
        order: 2;
      }

      /* Stock error styling */
      .stock-error {
        color: #dc3545;
        font-size: 12px;
        margin-top: 5px;
        font-weight: 500;
      }

      /* Ensure quantity controls are properly spaced */
      .quantity {
        margin: 0 15px;
      }

      .quantity-cart-box {
        margin: 20px 0;
      }

      .quantity-cart-box h5 {
        margin: 0 10px 0 0;
        font-size: 14px;
        color: #333;
      }

      /* Button group styling */
      .button-group {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        flex-direction: column;
        gap: 5px;
        opacity: 0;
        transition: opacity 0.3s;
      }

      .product-thumb:hover .button-group {
        opacity: 1;
      }

      .button-group a,
      .button-group button {
        background: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #333;
        text-decoration: none;
        transition: all 0.3s;
      }

      .button-group a:hover,
      .button-group button:hover {
        background: #fff;
        transform: scale(1.1);
      }

      /* Add to cart button styling */
      .add-to-cart-btn {
        background: #ac3b61;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .add-to-cart-btn:hover {
        background: #123c69;
      }

      .add-to-cart-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }

      /* Adding to cart state */
      .adding-to-cart {
        background: #6c757d !important;
      }
    </style>

    <!--[if lt IE 9]>
      <script src="//oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="//oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>
    <header
      id="header-placeholder"
      hx-get="../components/header.html"
      hx-trigger="load"
      hx-swap="outerHTML"
    ></header>

    <!-- main wrapper start -->
    <main>
      <!-- page main wrapper start -->
      <div class="shop-main-wrapper section-space">
        <div class="container">
          <div class="row">
            <!-- product details wrapper start -->
            <div class="col-lg-12 order-1 order-lg-2">
              <div class="product-details-inner">
                <div class="row">
                  <div class="col-lg-5">
                    <div class="product-large-slider">
                      <div class="pro-large-img img-zoom">
                        <img src="" alt="product-details" />
                      </div>
                      <div class="pro-large-img img-zoom">
                        <img src="" alt="product-details" />
                      </div>
                      <div class="pro-large-img img-zoom">
                        <img src="" alt="product-details" />
                      </div>
                      <div class="pro-large-img img-zoom">
                        <img src="" alt="product-details" />
                      </div>
                      <div class="pro-large-img img-zoom">
                        <img src="" alt="product-details" />
                      </div>
                    </div>
                    <div class="pro-nav slick-row-10 slick-arrow-style">
                      <div class="pro-nav-thumb">
                        <img
                          src="assets/img/product/product-details-img1.jpg"
                          alt="product-details"
                        />
                      </div>
                      <div class="pro-nav-thumb">
                        <img
                          src="assets/img/product/product-details-img2.jpg"
                          alt="product-details"
                        />
                      </div>
                      <div class="pro-nav-thumb">
                        <img
                          src="assets/img/product/product-details-img3.jpg"
                          alt="product-details"
                        />
                      </div>
                      <div class="pro-nav-thumb">
                        <img
                          src="assets/img/product/product-details-img4.jpg"
                          alt="product-details"
                        />
                      </div>
                      <div class="pro-nav-thumb">
                        <img
                          src="assets/img/product/product-details-img5.jpg"
                          alt="product-details"
                        />
                      </div>
                    </div>
                  </div>
                  <div class="col-lg-7">
                    <div class="product-details-des">
                      <h3 class="product-name"></h3>
                      <div class="price-box">
                        <span class="price-regular"></span>
                        <span class="price-old"><del></del></span>
                      </div>
                      <div class="availability">
                        <i class="fa fa-check-circle product-stock"></i>
                        <span></span>
                      </div>
                      <p class="pro-desc description"></p>
                      <div class="quantity-cart-box d-flex align-items-center">
                        <h5>qty:</h5>
                        <div class="quantity">
                          <div class="pro-qty" id="quantityControls">
                            <input
                              type="number"
                              id="productQuantity"
                              value="1"
                              min="1"
                              max="100"
                              step="1"
                              inputmode="numeric"
                              placeholder="Enter quantity"
                            />
                          </div>
                          <div
                            id="stockError"
                            class="stock-error"
                            style="
                              display: none;
                              color: #dc3545;
                              font-size: 12px;
                              margin-top: 5px;
                            "
                          >
                            Số lượng vượt quá tồn kho hiện tại
                          </div>
                        </div>
                        <div class="action_link">
                          <button
                            class="btn btn-cart2 add-to-cart-btn"
                            data-product-id=""
                            data-quantity="1"
                          >
                            <i class="fa fa-shopping-cart"></i> Add to cart
                          </button>
                        </div>
                      </div>
                      <div class="like-icon">
                        <a class="facebook" href="#"
                          ><i class="fa fa-facebook"></i>like</a
                        >
                        <a class="twitter" href="#"
                          ><i class="fa fa-twitter"></i>tweet</a
                        >
                        <a class="pinterest" href="#"
                          ><i class="fa fa-pinterest"></i>save</a
                        >
                        <a class="google" href="#"
                          ><i class="fa fa-google-plus"></i>share</a
                        >
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- product details inner end -->
            </div>
            <!-- product details wrapper end -->
          </div>
        </div>
      </div>
      <!-- page main wrapper end -->
    </main>
    <!-- main wrapper end -->
    <div
      hx-get="../components/footer.html"
      hx-trigger="load"
      hx-swap="outerHTML"
    ></div>
    <!-- Quick view modal start -->
    <div class="modal" id="quick_view">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-bs-dismiss="modal">
              &times;
            </button>
          </div>
          <script>
            document.addEventListener("DOMContentLoaded", async () => {
              const slider = document.querySelector(".product-large-slider");
              const thumbs = document.querySelector(".pro-nav");

              const params = new URLSearchParams(window.location.search);
              const productId = params.get("id") || 1;

              try {
                // Gọi API lấy chi tiết sản phẩm
                const res = await fetch(
                  `https://localhost:7062/api/Product/${productId}`
                );
                const json = await res.json();

                if (!json.succeeded) {
                  console.error("Không lấy được dữ liệu sản phẩm");
                  return;
                }

                const p = json.data;

                // --- Cập nhật thông tin sản phẩm ---
                document.querySelector(".product-name").textContent = p.name;
                document.querySelector(".price-regular").textContent =
                  p.price.toLocaleString("vi-VN") + " ₫";
                document.querySelector(".price-old del").textContent =
                  (p.price * 1.2).toLocaleString("vi-VN") + " ₫";

                const stockEl = document.querySelector(".availability span");
                if (p.stock > 0) {
                  stockEl.textContent = `${p.stock} available`;
                  document
                    .querySelector(".product-stock")
                    ?.style.setProperty("color", "green");
                } else {
                  stockEl.textContent = "Out of stock";
                  document
                    .querySelector(".product-stock")
                    ?.style.setProperty("color", "red");
                }

                document.querySelector(".description").textContent =
                  p.description;
              } catch (error) {
                console.error("Lỗi khi load sản phẩm:", error);
              }
            });
          </script>
        </div>
      </div>
    </div>
    <!-- Quick view modal end -->
    <!-- Scroll to top start -->
    <div class="scroll-top not-visible">
      <i class="fa fa-angle-up"></i>
    </div>
    <!-- Scroll to Top End -->
    <!-- All vendor & plugins & active js include here -->
    <!--All Vendor Js -->
    <script src="../../js/vendor.js"></script>
    <!-- Active Js -->
    <script src="../../js/active.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <!-- Services and Components -->
    <script type="module" src="../../js/services/ApiService.js"></script>
    <script type="module" src="../../js/component/cart/CartManager.js"></script>
    <script
      type="module"
      src="../../js/component/header/HeaderManager.js"
    ></script>

    <!--<script src="../../js/product.-details.js"></script>-->
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const params = new URLSearchParams(window.location.search);
        const productId = params.get("id") || 1;

        try {
          const res = await fetch(
            `https://localhost:7062/api/Product/${productId}`
          );
          const json = await res.json();

          if (!json.succeeded) {
            console.error("Không lấy được dữ liệu sản phẩm");
            return;
          }

          const p = json.data;

          // ====== Gán thông tin sản phẩm ======
          document.querySelector(".product-name").textContent = p.name;
          document.querySelector(".price-regular").textContent =
            p.price.toLocaleString("vi-VN") + " ₫";
          document.querySelector(".price-old del").textContent =
            (p.price * 1.2).toLocaleString("vi-VN") + " ₫";

          const stockEl = document.querySelector(".availability span");
          if (p.stock > 0) {
            stockEl.textContent = `${p.stock} available`;
            document.querySelector(".product-stock").style.color = "green";
          } else {
            stockEl.textContent = "Out of stock";
            document.querySelector(".product-stock").style.color = "red";
          }

          document.querySelector(".description").textContent = p.description;

          // ====== Slider xử lý ======
          const $largeSlider = $(".product-large-slider");
          const $thumbs = $(".pro-nav");

          // Nếu slick chưa init thì init trước
          if (!$largeSlider.hasClass("slick-initialized")) {
            $largeSlider.slick({
              slidesToShow: 1,
              slidesToScroll: 1,
              arrows: true,
              fade: true,
              asNavFor: ".pro-nav",
            });
          }

          if (!$thumbs.hasClass("slick-initialized")) {
            $thumbs.slick({
              slidesToShow: 4,
              slidesToScroll: 1,
              asNavFor: ".product-large-slider",
              dots: false,
              focusOnSelect: true,
            });
          }

          // Xóa ảnh cũ
          let slideCount = $largeSlider.slick("getSlick").slideCount;
          for (let i = slideCount - 1; i >= 0; i--) {
            $largeSlider.slick("slickRemove", i);
            $thumbs.slick("slickRemove", i);
          }

          // Sắp xếp ảnh: primary trước
          const photos = [...p.productPhotos].sort(
            (a, b) => b.isPrimary - a.isPrimary
          );

          // Thêm ảnh mới
          photos.forEach((photo) => {
            const fullUrl = `https://localhost:7062${photo.url}`;

            $largeSlider.slick(
              "slickAdd",
              `
                                <div class="pro-large-img img-zoom">
                                    <img src="${fullUrl}" alt="product-details"
                                         style="width:100%; height:500px; object-fit:contain;" />
                                </div>
                            `
            );

            $thumbs.slick(
              "slickAdd",
              `
                                <div class="pro-nav-thumb">
                                    <img src="${fullUrl}" alt="product-thumb"
                                         style="width:100px; height:100px; object-fit:cover;" />
                                </div>
                            `
            );
          });

          // Set product ID for add to cart button
          const addToCartBtn = document.querySelector(".add-to-cart-btn");
          if (addToCartBtn) {
            addToCartBtn.setAttribute("data-product-id", productId);
          }

          // Setup quantity controls
          const setStock = setupQuantityControls();
          setStock(p.stock); // Pass the actual stock to the function
        } catch (err) {
          console.error("Lỗi khi load sản phẩm:", err);
        }
      });

      // Function to setup quantity controls
      let quantityControlsSetup = false;

      function setupQuantityControls() {
        if (quantityControlsSetup) {
          console.log("Quantity controls already set up, skipping...");
          return;
        }

        console.log("Setting up quantity controls...");

        // Clear any existing content and recreate
        const quantityControlsContainer =
          document.getElementById("quantityControls");
        if (!quantityControlsContainer) {
          console.error("Quantity controls container not found");
          return;
        }

        // Clear and recreate the controls to ensure no duplicates
        quantityControlsContainer.innerHTML = `
          <input type="number" id="productQuantity" value="1" min="1" max="100" step="1" inputmode="numeric" placeholder="Enter quantity" />
        `;

        const quantityInput = document.getElementById("productQuantity");
        const addToCartBtn = document.querySelector(".add-to-cart-btn");
        const stockErrorDiv = document.getElementById("stockError");

        console.log("Elements found:", {
          quantityInput: !!quantityInput,
          addToCartBtn: !!addToCartBtn,
          stockErrorDiv: !!stockErrorDiv,
        });

        let currentStock = 0; // Will be set when product loads

        if (!quantityInput || !addToCartBtn || !stockErrorDiv) {
          console.error("Some elements not found, returning early");
          return;
        }

        // Function to validate quantity against stock
        function validateQuantity(quantity) {
          if (quantity <= 0) {
            stockErrorDiv.style.display = "none";
            addToCartBtn.disabled = true;
            return false;
          } else if (quantity > currentStock) {
            stockErrorDiv.style.display = "block";
            stockErrorDiv.textContent = `Số lượng vượt quá tồn kho hiện tại (${currentStock})`;
            addToCartBtn.disabled = true;
            return false;
          } else {
            stockErrorDiv.style.display = "none";
            addToCartBtn.disabled = false;
            return true;
          }
        }

        // Update quantity when input changes
        quantityInput.addEventListener("change", function () {
          let value = parseInt(this.value) || 1;
          value = Math.max(1, Math.min(100, value)); // Ensure value is between 1 and 100
          this.value = value;
          addToCartBtn.setAttribute("data-quantity", value);
          // Validate against stock
          validateQuantity(value);
        });

        // Real-time validation as user types
        quantityInput.addEventListener("input", function () {
          let value = parseInt(this.value) || 0;
          if (value > 0) {
            addToCartBtn.setAttribute("data-quantity", value);
            // Validate against stock in real-time
            validateQuantity(value);
          }
        });

        // Prevent native number input behavior
        quantityInput.addEventListener("keydown", function (e) {
          // Allow: backspace, delete, tab, escape, enter, and numbers
          if (
            [46, 8, 9, 27, 13].indexOf(e.keyCode) !== -1 ||
            // Allow Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
            (e.keyCode === 65 && e.ctrlKey === true) ||
            (e.keyCode === 67 && e.ctrlKey === true) ||
            (e.keyCode === 86 && e.ctrlKey === true) ||
            (e.keyCode === 88 && e.ctrlKey === true) ||
            // Allow numbers and decimal point
            (e.keyCode >= 48 && e.keyCode <= 57) ||
            (e.keyCode >= 96 && e.keyCode <= 105)
          ) {
            return;
          }
          // Ensure that it is a number and stop the keypress
          if (
            (e.shiftKey || e.keyCode < 48 || e.keyCode > 57) &&
            (e.keyCode < 96 || e.keyCode > 105)
          ) {
            e.preventDefault();
          }
        });

        // Prevent mouse wheel from changing quantity
        quantityInput.addEventListener(
          "wheel",
          function (e) {
            e.preventDefault();
          },
          { passive: false }
        );

        // Add to cart functionality
        addToCartBtn.addEventListener("click", async function () {
          const productId = this.getAttribute("data-product-id");
          const quantity = parseInt(this.getAttribute("data-quantity")) || 1;

          if (!productId) {
            showToast("Không thể xác định sản phẩm", "error");
            return;
          }

          // Check if user is authenticated
          const token = localStorage.getItem("auth_token");
          if (!token) {
            showToast(
              "Vui lòng đăng nhập để thêm sản phẩm vào giỏ hàng",
              "warning"
            );
            setTimeout(() => {
              window.location.href = "/html/auth/login-register.html";
            }, 2000);
            return;
          }

          // Final stock validation before adding to cart
          if (quantity > currentStock) {
            showToast("Số lượng vượt quá tồn kho hiện tại", "error");
            return;
          }

          try {
            // Set button loading state
            this.disabled = true;
            this.innerHTML =
              '<i class="fa fa-spinner fa-spin"></i> Đang thêm...';

            // Import CartManager dynamically
            const { CartManager } = await import(
              "../../js/component/cart/CartManager.js"
            );

            // Check if CartManager instance exists globally, if not create one
            if (!window.globalCartManager) {
              window.globalCartManager = new CartManager();
            }

            // Use the CartManager to add product to cart
            await window.globalCartManager.addToCart(productId, quantity);

            // Show success toast
            showToast("Đã thêm sản phẩm vào giỏ hàng!", "success");

            // Reset button state
            setTimeout(() => {
              this.disabled = false;
              this.innerHTML =
                '<i class="fa fa-shopping-cart"></i> Add to cart';
            }, 2000);
          } catch (error) {
            console.error("Error adding to cart:", error);
            showToast("Có lỗi xảy ra khi thêm vào giỏ hàng", "error");

            // Reset button state
            this.disabled = false;
            this.innerHTML = '<i class="fa fa-shopping-cart"></i> Add to cart';
          }
        });

        // Mark as set up
        quantityControlsSetup = true;

        // Return the function to set current stock
        return function setStock(stock) {
          currentStock = stock;
          // Set max attribute for input
          quantityInput.max = stock;
          // Validate current quantity
          validateQuantity(parseInt(quantityInput.value) || 1);
        };
      }

      // Function to show toast notifications
      function showToast(message, type = "success") {
        const toast = document.createElement("div");
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
                <div class="toast-content">
                    <i class="fa fa-${
                      type === "success"
                        ? "check"
                        : type === "warning"
                        ? "exclamation-triangle"
                        : "times-circle"
                    }"></i>
                    <span>${message}</span>
                </div>
            `;

        document.body.appendChild(toast);

        setTimeout(() => {
          toast.classList.add("show");
        }, 100);

        setTimeout(() => {
          toast.remove();
        }, 3000);
      }
    </script>
  </body>
</html>
