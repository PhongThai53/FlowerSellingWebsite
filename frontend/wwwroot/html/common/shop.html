<!DOCTYPE html>
<html class="no-js" lang="zxx">
  <!-- Mirrored from htmldemo.net/floda/floda/shop.html by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 13 Aug 2025 01:29:25 GMT -->
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="meta description" />
    <title>Floda - Flower eCommerce Bootstrap 5 Template</title>

    <!--=== Favicon ===-->
    <link
      rel="shortcut icon"
      href="../../img/favicon.ico"
      type="image/x-icon"
    />

    <!-- Google fonts include -->
    <link
      href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,500,500i,700,900%7CYesteryear"
      rel="stylesheet"
    />

    <!-- All Vendor & plugins CSS include -->
    <link href="../../css/vendor.css" rel="stylesheet" />
    <!-- Main Style CSS -->
    <link href="../../css/style.css" rel="stylesheet" />
    <!-- Cart CSS for toast notifications -->
    <link href="../../css/cart.css" rel="stylesheet" />

    <!--[if lt IE 9]>
      <script src="//oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="//oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />

    <style>
      /* Button group styling for shop products */
      .product-thumb {
        position: relative;
      }

      .button-group {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        flex-direction: column;
        gap: 5px;
        opacity: 0;
        transition: opacity 0.3s;
      }

      .product-thumb:hover .button-group {
        opacity: 1;
      }

      .button-group a,
      .button-group button {
        background: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #333;
        text-decoration: none;
        transition: all 0.3s;
      }

      .button-group a:hover,
      .button-group button:hover {
        background: #fff;
        transform: scale(1.1);
      }

      /* Add to cart button styling */
      .add-to-cart-btn {
        background: #ac3b61;
        color: white;
        border: none;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
      }

      .add-to-cart-btn:hover:not(:disabled) {
        background: #8a2d4e;
        transform: scale(1.1);
      }

      .add-to-cart-btn:disabled {
        cursor: not-allowed;
        opacity: 0.6;
      }

      /* Adding to cart state */
      .adding-to-cart {
        background: #6c757d !important;
      }
    </style>
  </head>

  <body>
    <header
      id="header-placeholder"
      hx-get="../components/header.html"
      hx-trigger="load"
      hx-swap="outerHTML"
    ></header>
    <!-- main wrapper start -->
    <main>
      <!-- breadcrumb area start -->
      <div class="breadcrumb-area common-bg">
        <div class="container">
          <div class="row">
            <div class="col-12">
              <div class="breadcrumb-wrap">
                <nav aria-label="breadcrumb">
                  <h1>shop</h1>
                  <ul class="breadcrumb">
                    <li class="breadcrumb-item">
                      <a href="index.html"><i class="fa fa-home"></i></a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">
                      shop
                    </li>
                  </ul>
                </nav>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- breadcrumb area end -->
      <!-- page main wrapper start -->
      <div class="shop-main-wrapper section-space pb-0">
        <div class="container" id="featured-products-container">
          <div class="row">
            <!-- sidebar area start -->
            <div class="col-lg-3 order-2 order-lg-1">
              <aside class="sidebar-wrapper">
                <!-- single sidebar start -->
                <div class="sidebar-single">
                  <h3 class="sidebar-title">categories</h3>
                  <div class="sidebar-body">
                    <ul class="shop-categories"></ul>
                  </div>
                </div>
                <!--single sidebar end-->
                <!--single sidebar start-->
                <!--<div class="sidebar-single">
                                                              <h3 class="sidebar-title">price</h3>
                                                              <div class="sidebar-body">
                                                                  <div class="price-range-wrap">-->
                <!--SET RANGE TỪ DATABASE HOẶC DEFAULT-->
                <!--<div class="price-range price-range-slider"
                                                                           data-min="0"
                                                                           data-max="650000"
                                                                           data-default-min="50000"
                                                                           data-default-max="500000">
                                                                      </div>
                                                                      <div class="range-slider">
                                                                          <form action="#" class="d-flex align-items-center justify-content-between">
                                                                              <div class="price-input">
                                                                                  <label for="amount"></label>
                                                                                  <input type="text" id="amount" readonly>
                                                                              </div>
                                                                              <button type="button" class="filter-btn">filter</button>
                                                                          </form>
                                                                      </div>
                                                                  </div>
                                                              </div>
                                                          </div>-->
                <!-- single sidebar start -->
                <div class="sidebar-banner">
                  <div class="img-container">
                    <a href="#">
                      <img src="../../img/banner/sidebar-banner.jpg" alt="" />
                    </a>
                  </div>
                </div>
                <!-- single sidebar end -->
              </aside>
            </div>
            <!-- sidebar area end -->
            <!-- shop main wrapper start -->
            <div class="col-lg-9 order-1 order-lg-2">
              <div class="shop-product-wrapper">
                <!-- shop product top wrap start -->
                <div class="shop-top-bar">
                  <div class="row align-items-center">
                    <input
                      type="text"
                      id="searchInput"
                      placeholder="Tìm sản phẩm..."
                      class="form-control mb-2"
                      style="width: 100%"
                    />

                    <div class="col-lg-7 col-md-6 order-2 order-md-1">
                      <div class="top-bar-left">
                        <div class="product-view-mode">
                          <a
                            class="active"
                            href="#"
                            data-target="grid-view"
                            data-bs-toggle="tooltip"
                            title="Grid View"
                          >
                            <i class="fa fa-th"></i>
                          </a>
                        </div>
                        <div class="product-amount">
                          <p>Showing 1–5 of 8 results</p>
                        </div>
                      </div>
                    </div>
                    <div class="col-lg-5 col-md-6 order-1 order-md-2">
                      <div class="top-bar-right">
                        <select name="sortBy">
                          <option value="default">Default</option>
                          <option value="name,asc">Name (A-Z)</option>
                          <option value="name,desc">Name (Z-A)</option>
                          <!-- Commented out price sorting since prices are not displayed on shop page -->
                          <!-- <option value="price,asc">Price (Low to High)</option> -->
                          <!-- <option value="price,desc">Price (High to Low)</option> -->
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- shop product top wrap start -->
                <!-- product item list wrapper start -->
                <div
                  class="shop-product-wrap grid-view row mbn-40 shop-container"
                >
                  <!--product-->
                </div>
                <!-- product item list wrapper end -->
                <!-- start pagination area -->
                <div class="paginatoin-area text-center">
                  <ul class="pagination-box">
                    <li>
                      <a class="previous" href="#">
                        <i class="lnr lnr-chevron-left"></i>
                      </a>
                    </li>
                    <li class="active"><a href="#">1</a></li>
                    <li><a href="#">2</a></li>
                    <li><a href="#">3</a></li>
                    <li>
                      <a class="next" href="#">
                        <i class="lnr lnr-chevron-right"></i>
                      </a>
                    </li>
                  </ul>
                </div>
                <!-- end pagination area -->
              </div>
            </div>
            <!-- shop main wrapper end -->
          </div>
        </div>
      </div>
      <!-- page main wrapper end -->
    </main>
    <!-- main wrapper end -->
    <div
      hx-get="../components/footer.html"
      hx-trigger="load"
      hx-swap="outerHTML"
    ></div>
    <!-- Scroll to top start -->
    <div class="scroll-top not-visible">
      <i class="fa fa-angle-up"></i>
    </div>

    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <script src="../../js/vendor.js"></script>
    <!-- Active Js -->
    <script src="../../js/active.js"></script>
    <!-- Services and Components -->
    <script type="module" src="../../js/services/ApiService.js"></script>
    <script type="module" src="../../js/component/cart/CartManager.js"></script>
    <script
      type="module"
      src="../../js/component/header/HeaderManager.js"
    ></script>

    <script>
      const API_BASE = "https://localhost:7062/api";

      function productImage(id) {
        return `${API_BASE.replace(
          "/api",
          ""
        )}/images/products/${id}/primary.jpg`;
      }

      document.addEventListener("DOMContentLoaded", () => {
        const container = document.querySelector(".shop-product-wrap");
        const pagination = document.querySelector(".pagination-box");
        const categories = document.querySelector(".shop-categories");
        const productInfo = document.querySelector(".product-amount p");
        const niceSelect = document.querySelector(".nice-select");
        const searchInput = document.getElementById("searchInput");

        // Kiểm tra niceSelect có được tìm thấy không
        if (!niceSelect) {
          console.error(
            "Không tìm thấy div.nice-select! Vui lòng kiểm tra HTML và đảm bảo Nice Select được khởi tạo đúng."
          );
          container.innerHTML =
            "<p class='text-danger'>Lỗi: Không tìm thấy bộ chọn sắp xếp!</p>";
          return;
        }
        console.log("Đã tìm thấy niceSelect:", niceSelect);

        let state = {
          page: 1,
          size: 6,
          total: 0,
          pages: 0,
          category: "",
          sortBy: "id", // Mặc định sắp xếp theo ID
          asc: true, // Mặc định tăng dần
          search: "",
        };

        // Tải danh mục sản phẩm
        async function loadCategories() {
          try {
            let res = await fetch(`${API_BASE}/ProductCategory/with-products`);
            let { data, succeeded } = await res.json();
            if (!succeeded) {
              console.error("Lỗi tải danh mục:", data);
              categories.innerHTML =
                "<li><p class='text-danger'>Lỗi tải danh mục!</p></li>";
              return;
            }
            categories.innerHTML =
              `<li><a href="#" data-id="">Tất cả</a></li>` +
              data
                .map(
                  (c) =>
                    `<li><a href="#" data-id="${c.id}">${c.name} <span>${
                      c.totalProducts || 0
                    }</span></a></li>`
                )
                .join("");
          } catch (error) {
            console.error("Lỗi tải danh mục:", error);
            categories.innerHTML =
              "<li><p class='text-danger'>Lỗi tải danh mục!</p></li>";
          }
        }

        // Tải sản phẩm
        async function loadProducts() {
          container.innerHTML = `<div class="col-12 text-center p-5"><i class="fa fa-spinner fa-spin"></i> Đang tải...</div>`;
          let url = `${API_BASE}/Product?pageNumber=${state.page}&pageSize=${state.size}`;
          if (state.category) url += `&categoryId=${state.category}`;
          url += `&sortBy=${state.sortBy}&asc=${state.asc}`;
          if (state.search)
            url += `&search=${encodeURIComponent(state.search)}`;

          try {
            let res = await fetch(url);
            let { data, succeeded } = await res.json();
            console.log("Phản hồi API:", data); // Debug
            if (!succeeded) {
              container.innerHTML =
                "<p class='text-danger'>Lỗi tải sản phẩm!</p>";
              return;
            }

            let items = data.items || data;
            state.pages =
              data.totalPages || Math.ceil((data.totalCount || 0) / state.size);
            state.total = data.totalCount || items.length;

            // Hiển thị sản phẩm
            container.innerHTML = items
              .map(
                (p) => `
                                        <div class="col-md-4 col-sm-6">
                                            <div class="product-item">
                                                <figure class="product-thumb">
                                                    <a href="product-details.html?id=${
                                                      p.id
                                                    }">
                                                        <img class="pri-img" style="width:100%;height:250px;object-fit:cover"
                                                            src="${productImage(
                                                              p.id
                                                            )}" onerror="this.src='https://localhost:7062/images/products/default/default.jpg'">
                                                            <img class="sec-img" style="width:100%;height:250px;object-fit:cover"
        src="${productImage(
          p.id
        )}" onerror="this.src='https://localhost:7062/images/products/default/default.jpg'">
                                                    </a>
                                                    <div class="button-group">
                                                        <button class="add-to-cart-btn"
                                                                data-product-id="${
                                                                  p.id
                                                                }"
                                                                data-bs-toggle="tooltip"
                                                                data-bs-placement="left"
                                                                title="Thêm vào giỏ hàng">
                                                            <i class="lnr lnr-cart"></i>
                                                        </button>
                                                    </div>
                                                </figure>
                                                <div class="product-caption">
                                                    <p class="product-name"><a href="product-details.html?id=${
                                                      p.id
                                                    }">${p.name}</a></p>
                                                </div>
                                            </div>
                                        </div>`
              )
              .join("");

            // Check button states after rendering
            setTimeout(() => {
              const addToCartButtons =
                container.querySelectorAll(".add-to-cart-btn");
              addToCartButtons.forEach((btn) => {
                // Bỏ stock validation, chỉ cần enable button
                btn.disabled = false;
                btn.title = "Thêm vào giỏ hàng";
              });
            }, 100);

            // Hiển thị phân trang
            if (state.pages > 1) {
              let html = "";
              if (state.page > 1)
                html += `<li><a href="#" data-page="${
                  state.page - 1
                }"><i class="lnr lnr-chevron-left"></i></a></li>`;
              for (let i = 1; i <= state.pages; i++) {
                html += `<li class="${
                  i === state.page ? "active" : ""
                }"><a href="#" data-page="${i}">${i}</a></li>`;
              }
              if (state.page < state.pages)
                html += `<li><a href="#" data-page="${
                  state.page + 1
                }"><i class="lnr lnr-chevron-right"></i></a></li>`;
              pagination.innerHTML = html;
            } else {
              pagination.innerHTML = "";
            }

            // Cập nhật thông tin số lượng sản phẩm
            if (productInfo) {
              let start = (state.page - 1) * state.size + 1;
              let end = Math.min(state.page * state.size, state.total);
              productInfo.textContent = `Hiển thị ${start}–${end} trong số ${state.total} kết quả`;
            }
          } catch (error) {
            console.error("Lỗi tải sản phẩm:", error);
            container.innerHTML =
              "<p class='text-danger'>Lỗi tải sản phẩm!</p>";
          }
        }

        // Xử lý sự kiện chọn danh mục
        categories.addEventListener("click", (e) => {
          let link = e.target.closest("a[data-id]");
          if (!link) return;
          e.preventDefault();
          state.category = link.dataset.id;
          state.page = 1;
          loadProducts();
        });

        // Xử lý sự kiện phân trang
        pagination.addEventListener("click", (e) => {
          let btn = e.target.closest("a[data-page]");
          if (!btn) return;
          e.preventDefault();
          state.page = parseInt(btn.dataset.page);
          loadProducts();
        });

        // Xử lý sự kiện sắp xếp trên nice-select
        niceSelect.addEventListener("click", (e) => {
          const selectedOption = e.target.closest(".option");
          if (!selectedOption) return;
          const value = selectedOption.getAttribute("data-value");
          console.log("Sự kiện click trên nice-select, giá trị:", value); // Debug
          const [sortBy, asc] = value.split(",");
          state.sortBy = sortBy || "id"; // Fallback nếu sortBy rỗng
          state.asc = asc === "true"; // Chuyển đổi thành boolean
          console.log("Cập nhật state:", {
            sortBy: state.sortBy,
            asc: state.asc,
          }); // Debug
          state.page = 1;
          loadProducts();
        });

        // Khởi tạo
        loadCategories();
        loadProducts();

        // Xử lý tìm kiếm với debounce
        let searchTimeout;
        searchInput.addEventListener("input", (e) => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            state.search = e.target.value.trim();
            state.page = 1;
            loadProducts();
          }, 500); // Chờ 0.5s sau khi ngừng gõ
        });

        // Setup add to cart functionality
        setupAddToCartFunctionality();

        // Listen for authentication changes to refresh button states
        document.addEventListener("authChanged", () => {
          setTimeout(() => {
            refreshAllButtonStates();
          }, 500);
        });

        // Listen for cart updates to refresh button states
        document.addEventListener("cartUpdated", () => {
          setTimeout(() => {
            refreshAllButtonStates();
          }, 500);
        });
      });

      // Function to refresh all add-to-cart button states
      async function refreshAllButtonStates() {
        const allButtons = document.querySelectorAll(".add-to-cart-btn");
        for (const button of allButtons) {
          // Bỏ stock validation, chỉ cần enable button
          button.disabled = false;
          button.title = "Thêm vào giỏ hàng";
        }
      }

      // Function to check if add-to-cart button should be disabled
      // Đã bỏ stock validation - function này không còn cần thiết
      // async function checkAddToCartButtonState(btn) { ... }

      // Function to setup add to cart functionality
      function setupAddToCartFunctionality() {
        document.addEventListener("click", async (e) => {
          if (e.target.closest(".add-to-cart-btn")) {
            e.preventDefault();
            const btn = e.target.closest(".add-to-cart-btn");
            const productId = btn.getAttribute("data-product-id");

            // Prevent double-click
            if (btn.classList.contains("adding-to-cart")) {
              return;
            }

            await addToCart(productId, btn);
          }
        });
      }

      // Function to add product to cart
      async function addToCart(productId, btn) {
        try {
          // Check if user is authenticated
          const token = localStorage.getItem("auth_token");
          if (!token) {
            showToast(
              "Vui lòng đăng nhập để thêm sản phẩm vào giỏ hàng",
              "warning"
            );
            setTimeout(() => {
              window.location.href = "/html/auth/login-register.html";
            }, 2000);
            return;
          }

          // Check product availability first
          const availabilityResponse = await fetch(
            `${API_BASE}/Product/check-availability/${productId}?quantity=1`
          );
          const availabilityResult = await availabilityResponse.json();

          if (!availabilityResult.succeeded) {
            showToast("Không thể kiểm tra khả năng cung cấp sản phẩm", "error");
            return;
          }

          const availability = availabilityResult.data;
          if (!availability.isAvailable) {
            showToast(availability.message, "warning");
            return;
          }

          // Set button loading state
          setButtonLoading(btn, true);

          // Import CartManager dynamically
          const { CartManager } = await import(
            "/js/component/cart/CartManager.js"
          );

          // Check if CartManager instance exists globally, if not create one
          if (!window.globalCartManager) {
            window.globalCartManager = new CartManager();
          }

          // Use the CartManager to add product to cart
          const added = await window.globalCartManager.addToCart(productId, 1);

          if (added) {
            // Show success toast
            showToast("Đã thêm sản phẩm vào giỏ hàng!", "success");

            // Set success state briefly
            setButtonSuccess(btn);
          }

          // Refresh all button states to reflect new cart state
          setTimeout(() => {
            const allButtons = document.querySelectorAll(".add-to-cart-btn");
            allButtons.forEach((button) => {
              // Bỏ stock validation, chỉ cần enable button
              button.disabled = false;
              button.title = "Thêm vào giỏ hàng";
            });
          }, 500);
        } catch (error) {
          console.error("Error adding to cart:", error);
          showToast("Có lỗi xảy ra khi thêm vào giỏ hàng", "error");
        } finally {
          // Reset button state after delay
          setTimeout(() => {
            setButtonLoading(btn, false);
          }, 2000);
        }
      }

      // Function to handle button loading states
      function setButtonLoading(btn, isLoading) {
        if (isLoading) {
          btn.classList.add("adding-to-cart");
          btn.disabled = true;
          const icon = btn.querySelector("i");
          if (icon) {
            icon.className = "fa fa-spinner fa-spin";
          }
        } else {
          btn.classList.remove("adding-to-cart");
          btn.disabled = false;
          const icon = btn.querySelector("i");
          if (icon) {
            icon.className = "lnr lnr-cart";
          }
        }
      }

      function setButtonSuccess(btn) {
        const icon = btn.querySelector("i");
        if (icon) {
          icon.className = "fa fa-check";
          btn.style.background = "#28a745";
        }
      }

      // Function to show toast notifications
      function showToast(message, type = "success") {
        const toast = document.createElement("div");
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
                    <div class="toast-content">
                        <i class="fa fa-${
                          type === "success"
                            ? "check"
                            : type === "warning"
                            ? "exclamation-triangle"
                            : "times-circle"
                        }"></i>
                        <span>${message}</span>
                    </div>
                `;

        document.body.appendChild(toast);

        setTimeout(() => {
          toast.classList.add("show");
        }, 100);

        setTimeout(() => {
          toast.remove();
        }, 3000);
      }
    </script>
  </body>

  <!-- Mirrored from htmldemo.net/floda/floda/shop.html by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 13 Aug 2025 01:29:25 GMT -->
</html>
