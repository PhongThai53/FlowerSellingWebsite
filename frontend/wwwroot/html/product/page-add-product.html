<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>POS Dash | Responsive Bootstrap 4 Admin Dashboard Template</title>

    <!-- Favicon -->
    <link rel="shortcut icon" href="../../images/logo/favicon.ico" />
    <link rel="stylesheet" href="../../css/backend-plugin.min.css" />
    <link rel="stylesheet" href="../../css/backend.css?v=1.0.0" />
    <link
      rel="stylesheet"
      href="../../css/@fortawesome/fontawesome-free/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="../../css/line-awesome/dist/line-awesome/css/line-awesome.min.css"
    />
    <link rel="stylesheet" href="../../css/remixicon/fonts/remixicon.css" />
  </head>
  <body class="  ">
    <!-- loader Start -->
    <div id="loading">
      <div id="loading-center"></div>
    </div>
    <!-- loader END -->
    <!-- Wrapper Start -->
    <div class="wrapper">
      <!-- Nav -->
      <div id="nav-placeholder"></div>

      <!-- Header -->
      <div id="header-placeholder"></div>

      <div
        class="modal fade"
        id="new-order"
        tabindex="-1"
        role="dialog"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-body">
              <div class="popup text-left">
                <h4 class="mb-3">New Order</h4>
                <div class="content create-workform bg-body">
                  <div class="pb-3">
                    <label class="mb-2">Email</label>
                    <input
                      type="text"
                      class="form-control"
                      placeholder="Enter Name or Email"
                    />
                  </div>
                  <div class="col-lg-12 mt-4">
                    <div
                      class="d-flex flex-wrap align-items-ceter justify-content-center"
                    >
                      <div class="btn btn-primary mr-4" data-dismiss="modal">
                        Cancel
                      </div>
                      <div class="btn btn-outline-primary" data-dismiss="modal">
                        Create
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="content-page">
        <div class="container-fluid add-form-list">
          <div class="row">
            <div class="col-sm-12">
              <div class="card">
                <div class="card-header d-flex justify-content-between">
                  <div class="header-title">
                    <h4 class="card-title">Add Product</h4>
                  </div>
                </div>
                <div class="card-body">
                  <form id="addProductForm" novalidate>
                    <div class="row">
                      <div class="col-md-6">
                        <div class="form-group">
                          <label>Name *</label>
                          <input
                            type="text"
                            name="name"
                            class="form-control"
                            placeholder="Enter Product Name"
                            required
                          />
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <label>Price *</label>
                          <input
                            type="number"
                            name="price"
                            class="form-control"
                            placeholder="Enter Price"
                            step="0.01"
                            min="0.01"
                            required
                          />
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <label>Stock *</label>
                          <input
                            type="number"
                            name="stock"
                            class="form-control"
                            placeholder="Enter Stock Quantity"
                            min="0"
                            required
                          />
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <label>Category *</label>
                          <select
                            id="categorySelect"
                            name="categoryId"
                            class="selectpicker form-control"
                            data-style="py-0"
                            required
                          >
                            <option value="">Select Category</option>
                          </select>
                        </div>
                      </div>
                      <div class="col-md-12">
                        <div class="form-group">
                          <label>Description</label>
                          <textarea
                            name="description"
                            class="form-control"
                            rows="4"
                            placeholder="Enter product description..."
                          ></textarea>
                        </div>
                      </div>
                      <div class="col-md-12">
                        <div style="margin-bottom: 15px" class="form-group">
                          <label
                            style="
                              display: block;
                              font-weight: bold;
                              margin-bottom: 5px;
                            "
                            >Product Images</label
                          >
                          <input
                            type="file"
                            id="productPhotos"
                            name="productPhotos"
                            accept="image/*"
                            multiple
                            style="
                              padding: 5px;
                              border: 1px solid #ccc;
                              border-radius: 4px;
                            "
                          />
                          <small
                            style="display: block; margin-top: 5px; color: #666"
                            >Select multiple images. First image will be
                            primary.</small
                          >
                        </div>

                        <!-- Khu vực hiển thị preview -->
                        <div
                          id="preview-container"
                          style="
                            display: flex;
                            flex-wrap: wrap;
                            gap: 10px;
                            margin: 15px 0;
                          "
                        ></div>
                      </div>
                    </div>
                    <button type="submit" class="btn btn-primary mr-2">
                      Add Product
                    </button>
                    <button type="reset" class="btn btn-danger">Reset</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
          <!-- Page end  -->
        </div>
      </div>
    </div>
    <!-- Wrapper End-->
    <footer class="iq-footer">
      <div class="container-fluid">
        <div class="card">
          <div class="card-body">
            <div class="row">
              <div class="col-lg-6">
                <ul class="list-inline mb-0">
                  <li class="list-inline-item">
                    <a href="../backend/privacy-policy.html">Privacy Policy</a>
                  </li>
                  <li class="list-inline-item">
                    <a href="../backend/terms-of-service.html">Terms of Use</a>
                  </li>
                </ul>
              </div>
              <div class="col-lg-6 text-right">
                <span class="mr-1">
                  <script>
                    document.write(new Date().getFullYear());
                  </script>
                  ©
                </span>
                <a href="#" class="">POS Dash</a>.
              </div>
            </div>
          </div>
        </div>
      </div>
    </footer>
    <!-- Backend Bundle JavaScript -->
    <script>
      fetch("nav.html")
        .then((response) => response.text())
        .then((data) => {
          document.getElementById("nav-placeholder").innerHTML = data;
        });
    </script>
    <script>
      fetch("header.html")
        .then((response) => response.text())
        .then((data) => {
          document.getElementById("header-placeholder").innerHTML = data;
        });
    </script>
    <!--nav-->
    <!--header-->
    <!-- Backend Bundle JavaScript -->
    <script src="../../js/admin/backend-bundle.min.js"></script>
    <!-- Table Treeview JavaScript -->
    <script src="../../js/admin/table-treeview.js"></script>
    <!-- Chart Custom JavaScript -->
    <script src="../../js/admin/customizer.js"></script>
    <!-- Chart Custom JavaScript -->
    <script async src="../../js/admin/chart-custom.js"></script>
    <!-- app JavaScript -->
    <script src="../../js/admin/app.js"></script>

    <script>
      const API_BASE = "https://localhost:7062"; // sửa nếu API khác

      // DOM refs
      const form = document.getElementById("addProductForm");
      const catSelect = document.getElementById("categorySelect");
      const fileInput = document.getElementById("productPhotos");
      const preview = document.getElementById("preview-container");

      // ---------------- helpers ----------------
      async function fetchJSON(url, options = {}) {
        const res = await fetch(url, options);
        const text = await res.text();
        let json = null;
        try {
          json = text ? JSON.parse(text) : null;
        } catch (e) {
          json = null;
        }
        if (!res.ok) {
          const msg =
            (json && (json.message || json.error)) ||
            text ||
            `HTTP ${res.status}`;
          throw new Error(msg);
        }
        return json ?? text;
      }

      function escapeHtml(s = "") {
        return String(s).replace(
          /[&<>"']/g,
          (m) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[m])
        );
      }

      // ---------------- load categories ----------------
      async function loadCategories() {
        if (!catSelect) return;
        catSelect.disabled = true;
        catSelect.innerHTML = `<option value="">Loading...</option>`;
        try {
          const raw = await fetchJSON(`${API_BASE}/api/ProductCategory`);
          const list = Array.isArray(raw?.data)
            ? raw.data
            : Array.isArray(raw)
            ? raw
            : [];
          catSelect.innerHTML = `<option value="">Select Category</option>`;
          list.forEach((c) => {
            const opt = document.createElement("option");
            opt.value = c.id;
            opt.textContent = c.name;
            catSelect.appendChild(opt);
          });

          // Refresh bootstrap-select nếu có
          try {
            if (
              window.jQuery &&
              typeof jQuery(".selectpicker").selectpicker === "function"
            ) {
              jQuery(".selectpicker").selectpicker("refresh");
            }
          } catch (e) {
            console.warn("selectpicker refresh failed", e);
          }
        } catch (err) {
          console.error("loadCategories failed:", err);
          catSelect.innerHTML = `<option value="">Error loading</option>`;
        } finally {
          catSelect.disabled = false;
        }
      }

      // ---------------- preview images ----------------
      function initPreviewHandler() {
        if (!fileInput || !preview) return;
        fileInput.addEventListener("change", () => {
          preview.innerHTML = "";
          const files = Array.from(fileInput.files || []);
          files.forEach((file, idx) => {
            const wrapper = document.createElement("div");
            wrapper.style.position = "relative";
            wrapper.style.display = "inline-block";
            wrapper.style.marginRight = "8px";

            const img = document.createElement("img");
            img.alt = file.name;
            img.title = file.name;
            Object.assign(img.style, {
              width: "90px",
              height: "90px",
              objectFit: "cover",
              border: "1px solid #ddd",
              borderRadius: "6px",
            });

            const reader = new FileReader();
            reader.onload = (e) => {
              img.src = e.target.result;
            };
            reader.readAsDataURL(file);

            const btn = document.createElement("button");
            btn.type = "button";
            btn.innerText = "×";
            Object.assign(btn.style, {
              position: "absolute",
              top: "2px",
              right: "2px",
              width: "20px",
              height: "20px",
              borderRadius: "50%",
              border: "none",
              background: "rgba(0,0,0,0.6)",
              color: "#fff",
              cursor: "pointer",
            });
            btn.title = "Remove this image";
            btn.addEventListener("click", () => {
              const arr = Array.from(fileInput.files || []);
              arr.splice(idx, 1);
              const dt = new DataTransfer();
              arr.forEach((f) => dt.items.add(f));
              fileInput.files = dt.files;
              fileInput.dispatchEvent(new Event("change"));
            });

            wrapper.appendChild(img);
            wrapper.appendChild(btn);
            preview.appendChild(wrapper);
          });
        });
      }

      // ---------------- upload images ----------------
      async function uploadImages(productId, files) {
        if (!files || !files.length) return [];
        const fd = new FormData();
        files.forEach((f, idx) => {
          const ext = f.name.substring(f.name.lastIndexOf("."));
          const primaryName = idx === 0 ? `primary${ext}` : f.name;
          fd.append("files", f, primaryName);
        });
        const res = await fetch(`${API_BASE}/api/Image/products/${productId}`, {
          method: "POST",
          body: fd,
        });
        const text = await res.text();
        let json = null;
        try {
          json = text ? JSON.parse(text) : null;
        } catch (e) {
          json = text;
        }
        if (!res.ok)
          throw new Error(
            (json && (json.message || json.error)) ||
              text ||
              `HTTP ${res.status}`
          );
        if (Array.isArray(json)) return json;
        if (Array.isArray(json?.data)) return json.data;
        return typeof json === "string" ? [json] : [json];
      }

      // ---------------- create & update product ----------------
      async function createProduct(payload) {
        const res = await fetch(`${API_BASE}/api/Product`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const location = res.headers.get("location");
        const text = await res.text();
        let json = null;
        try {
          json = text ? JSON.parse(text) : null;
        } catch {
          json = text;
        }
        if (!res.ok)
          throw new Error(
            (json && (json.message || json.error)) ||
              text ||
              `HTTP ${res.status}`
          );
        const id =
          json?.data?.id ||
          json?.id ||
          parseInt(location?.split("/").pop()) ||
          0;
        return { id, raw: json, location };
      }

      async function updateProduct(id, body) {
        const res = await fetch(`${API_BASE}/api/Product/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        const text = await res.text();
        let json = null;
        try {
          json = text ? JSON.parse(text) : null;
        } catch {
          json = text;
        }
        if (!res.ok)
          throw new Error(
            (json && (json.message || json.error)) ||
              text ||
              `HTTP ${res.status}`
          );
        return json;
      }

      // ---------------- submit handler ----------------
      async function handleSubmit(e) {
        console.log("=== FORM SUBMIT TRIGGERED ===");
        console.log("Event:", e);
        console.log("Form:", e.target);
        console.log("Form action:", e.target.action);
        console.log("Event type:", e.type);
        console.log("Event target:", e.target);
        console.log("Event currentTarget:", e.currentTarget);
        console.log("Event isTrusted:", e.isTrusted);

        e.preventDefault();
        e.stopPropagation(); // Ngăn event bubbling

        // Manual validation thay vì dùng Bootstrap validator
        const form = e.target;
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        try {
          const fd = new FormData(e.target);
          const name = (fd.get("name") || "").toString().trim();
          const description = (fd.get("description") || "").toString().trim();
          const price = parseFloat(fd.get("price"));
          const stock = parseInt(fd.get("stock"), 10);
          const categoryId = parseInt(fd.get("categoryId"), 10);
          const files = Array.from(fileInput?.files || []);

          if (
            !name ||
            isNaN(price) ||
            price < 0.01 ||
            isNaN(stock) ||
            isNaN(categoryId)
          ) {
            return alert(
              "Vui lòng nhập Name, Price(>=0.01), Stock và Category hợp lệ."
            );
          }

          // Tạo sản phẩm với đầy đủ thông tin trong 1 lần gọi API
          const createPayload = {
            name,
            description,
            price,
            url: "/images/products/placeholder.jpg", // URL mặc định
            stock,
            categoryId,
            productPhotos: [], // Khởi tạo danh sách ảnh rỗng
          };

          console.log("Creating product with payload:", createPayload);

          const { id: productId } = await createProduct(createPayload);
          if (!productId) {
            throw new Error(
              "Tạo sản phẩm xong nhưng không lấy được productId."
            );
          }

          console.log("Product created successfully with ID:", productId);

          // Upload ảnh nếu có
          if (files.length > 0) {
            try {
              const uploaded = await uploadImages(productId, files);
              console.log("Images uploaded successfully:", uploaded);
            } catch (uploadError) {
              console.warn(
                "Image upload failed, but product was created:",
                uploadError
              );
              // Không throw error vì sản phẩm đã được tạo thành công
            }
          }

          alert("Tạo sản phẩm hoàn tất!");
          e.target.reset();
          if (preview) preview.innerHTML = "";
          if (
            window.jQuery &&
            typeof jQuery(".selectpicker").selectpicker === "function"
          ) {
            jQuery(".selectpicker").selectpicker("refresh");
          }
        } catch (err) {
          console.error("Submit error:", err);
          alert("Lỗi: " + (err.message || err));
        }
      }

      // ---------------- init ----------------
      function init() {
        if (!form) return console.warn("Form element not found");

        console.log("Initializing form:", form);
        console.log("Form action:", form.action);
        console.log("Form method:", form.method);
        console.log("Form id:", form.id);
        console.log("Form classList:", form.classList);

        loadCategories().catch(console.error);
        initPreviewHandler();

        // Remove any existing event listeners to prevent duplicates
        console.log("Removing existing event listeners...");
        form.removeEventListener("submit", handleSubmit);

        console.log("Adding new event listener...");
        form.addEventListener("submit", handleSubmit);

        console.log("Form submit event listener added");
        console.log("Form event listeners count:", form.onclick ? 1 : 0);
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
      } else {
        init();
      }
    </script>
  </body>
</html>
