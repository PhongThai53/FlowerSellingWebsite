<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Xem Danh Sách Kho Hoa</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/supplier.css">
    <style>
        .listing-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .listing-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #007bff;
        }

        .listing-header h2 {
            margin: 0;
            color: #333;
        }

        .listing-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #007bff;
            font-size: 24px;
        }

        .stat-card p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }

        .listing-filters {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .filter-group input,
        .filter-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
        }

        .listing-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .table-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
        }

        .table-header h3 {
            margin: 0;
            color: #333;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border: 1px solid #f5c6cb;
            border-radius: 6px;
            margin: 20px 0;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 16px;
            border: 1px solid #007bff;
            background: white;
            color: #007bff;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pagination button:hover:not(:disabled) {
            background: #007bff;
            color: white;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div id="header-placeholder"></div>
    
    <div class="listing-container">
        <div class="listing-header">
            <h2>Danh Sách Kho Hoa</h2>
            <a href="view-flower-list.html" class="btn btn-primary">Quay lại danh sách hoa</a>
        </div>

        <!-- Statistics Cards -->
        <div class="listing-stats">
            <div class="stat-card">
                <h3 id="total-items">0</h3>
                <p>Tổng số hoa trong kho</p>
            </div>
            <div class="stat-card">
                <h3 id="total-value">0</h3>
                <p>Tổng giá trị kho (VND)</p>
            </div>
            <div class="stat-card">
                <h3 id="pending-items">0</h3>
                <p>Hoa đang chờ duyệt</p>
            </div>
        </div>

        <!-- Filters -->
        <div class="listing-filters">
            <h3>Bộ lọc</h3>
            <div class="filter-row">
                <div class="filter-group">
                    <label for="status-filter">Trạng thái</label>
                    <select id="status-filter">
                        <option value="">Tất cả trạng thái</option>
                        <option value="Pending">Chờ duyệt</option>
                        <option value="Active">Đang bán</option>
                        <option value="Inactive">Tạm ngưng</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="min-price">Giá tối thiểu (VND)</label>
                    <input type="number" id="min-price" placeholder="0" min="0">
                </div>
                <div class="filter-group">
                    <label for="max-price">Giá tối đa (VND)</label>
                    <input type="number" id="max-price" placeholder="1000000" min="0">
                </div>
                <div class="filter-actions">
                    <button id="apply-filters" class="btn btn-primary">Áp dụng</button>
                    <button id="clear-filters" class="btn btn-secondary">Xóa bộ lọc</button>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Đang tải dữ liệu...</p>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="error-message" style="display: none;">
            <div id="error-content"></div>
            <div id="error-actions" style="margin-top: 15px; text-align: center;">
                <a href="../auth/login-register.html" class="btn btn-primary">Đăng nhập lại</a>
            </div>
        </div>

        <!-- Listing Table -->
        <div class="listing-table">
            <div class="table-header">
                <h3>Chi tiết kho hàng</h3>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Tên hoa</th>
                            <th>Danh mục</th>
                            <th>Loại</th>
                            <th>Màu sắc</th>
                            <th>Kích thước</th>
                            <th>Số lượng</th>
                            <th>Giá (VND)</th>
                            <th>Thời hạn (ngày)</th>
                            <th>Đặt tối thiểu</th>
                            <th>Trạng thái</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="listing-tbody">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- No Data Message -->
        <div id="no-data" class="no-data" style="display: none;">
            <p>Không có hoa nào trong kho</p>
            <a href="view-flower-list.html" class="btn btn-primary">Thêm hoa vào kho</a>
        </div>

        <!-- Pagination -->
        <div id="pagination" class="pagination" style="display: none;">
            <button id="prev-page" class="btn">Trang trước</button>
            <span id="page-info">Trang 1</span>
            <button id="next-page" class="btn">Trang tiếp</button>
        </div>
    </div>

    <script>fetch('../supplier/header.html').then(response => response.text()).then(data => { 
        document.getElementById('header-placeholder').innerHTML = data; 
        // Khởi tạo logout manager sau khi header được load
        if (window.supplierLogoutManager) {
            window.supplierLogoutManager.reinit();
        }
    });</script>
    
         <!-- Supplier Authentication Check -->
     <script src="../../js/auth.js"></script>
     <script src="../../js/supplier-auth-check.js"></script>
     <script src="../../js/supplier-logout.js"></script>
    
    <script>
        class ListingManager {
            constructor() {
                this.apiBaseUrl = 'http://localhost:5062/api';
                this.currentPage = 1;
                this.pageSize = 101; // Lấy tất cả hoa
                this.currentFilters = {};
                
                this.init();
            }

            async init() {
                try {
                    // Kiểm tra authentication trước
                    const token = localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token');
                    if (!token) {
                        this.showError('Bạn cần đăng nhập để truy cập trang này. Vui lòng đăng nhập lại.');
                        return;
                    }
                    
                    this.setupEventListeners();
                    await this.loadListings();
                } catch (error) {
                    console.error('Error initializing:', error);
                    this.showError('Lỗi khi khởi tạo trang: ' + error.message);
                }
            }

            setupEventListeners() {
                // Filter events
                document.getElementById('apply-filters').addEventListener('click', () => {
                    this.applyFilters();
                });

                document.getElementById('clear-filters').addEventListener('click', () => {
                    this.clearFilters();
                });

                // Pagination events
                document.getElementById('prev-page').addEventListener('click', () => {
                    if (this.currentPage > 1) {
                        this.currentPage--;
                        this.loadListings();
                    }
                });

                document.getElementById('next-page').addEventListener('click', () => {
                    this.currentPage++;
                    this.loadListings();
                });
            }

            async loadListings() {
                try {
                    this.showLoading(true);
                    this.hideMessages();

                    const url = `${this.apiBaseUrl}/SupplierListing/list?page_index=${this.currentPage}&page_size=${this.pageSize}`;
                    
                    // Lấy JWT token từ localStorage hoặc sessionStorage
                    let headers = {};
                    const token = localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token');
                    console.log('JWT Token found:', token ? 'Yes' : 'No');
                    console.log('Token value:', token);
                    
                    if (token) {
                        headers['Authorization'] = `Bearer ${token}`;
                        console.log('Authorization header set:', headers['Authorization']);
                    } else {
                        console.log('No JWT token found in storage');
                    }
                    
                    console.log('Request headers:', headers);
                    console.log('Request URL:', url);
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: headers
                    });
                    
                    console.log('Response status:', response.status);
                    console.log('Response headers:', response.headers);
                    
                    if (!response.ok) {
                        if (response.status === 401) {
                            throw new Error('Unauthorized: Vui lòng đăng nhập lại');
                        } else if (response.status === 403) {
                            throw new Error('Forbidden: Bạn không có quyền truy cập');
                        } else {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                    }

                    const data = await response.json();
                    console.log('API Response:', data);

                    this.displayListings(data);
                    this.updateStatistics(data);
                    this.updatePagination(data);

                } catch (error) {
                    console.error('Error loading listings:', error);
                    this.showError(`Lỗi khi tải dữ liệu: ${error.message}`);
                } finally {
                    this.showLoading(false);
                }
            }

            displayListings(data) {
                const tbody = document.getElementById('listing-tbody');
                const noData = document.getElementById('no-data');

                if (!data.items || data.items.length === 0) {
                    tbody.innerHTML = '';
                    noData.style.display = 'block';
                    return;
                }

                noData.style.display = 'none';

                const rows = data.items.map(item => `
                    <tr>
                        <td>${item.flowerName || 'N/A'}</td>
                        <td>${item.categoryName || 'N/A'}</td>
                        <td>${item.typeName || 'N/A'}</td>
                        <td>${item.colorName || 'N/A'}</td>
                        <td>${item.flowerSize || 'N/A'}</td>
                        <td>${item.availableQuantity}</td>
                        <td>${item.unitPrice.toLocaleString('vi-VN')}</td>
                        <td>${item.shelfLifeDays}</td>
                        <td>${item.minOrderQty}</td>
                        <td>
                            <span class="status-badge status-${item.status.toLowerCase()}">
                                ${item.status}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-primary" onclick="listingManager.editListing(${item.supplierId}, ${item.flowerId})">
                                    Sửa
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="listingManager.viewDetails(${item.supplierId}, ${item.flowerId})">
                                    Chi tiết
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');

                tbody.innerHTML = rows;
            }

            updateStatistics(data) {
                if (!data.items) return;

                const totalItems = data.totalItems || data.items.length;
                const totalValue = data.items.reduce((sum, item) => sum + (item.unitPrice * item.availableQuantity), 0);
                const pendingItems = data.items.filter(item => item.status === 'Pending').length;

                document.getElementById('total-items').textContent = totalItems;
                document.getElementById('total-value').textContent = totalValue.toLocaleString('vi-VN');
                document.getElementById('pending-items').textContent = pendingItems;
            }

            updatePagination(data) {
                const pagination = document.getElementById('pagination');
                const prevBtn = document.getElementById('prev-page');
                const nextBtn = document.getElementById('next-page');
                const pageInfo = document.getElementById('page-info');

                if (!data.totalPages || data.totalPages <= 1) {
                    pagination.style.display = 'none';
                    return;
                }

                pagination.style.display = 'flex';
                pageInfo.textContent = `Trang ${data.page} / ${data.totalPages}`;
                
                // Sử dụng HasNext và HasPrev từ API response
                // Nếu không có, fallback về tính toán từ Page và TotalPages
                const hasNext = data.hasNext !== undefined ? data.hasNext : data.page < data.totalPages;
                const hasPrev = data.hasPrev !== undefined ? data.hasPrev : data.page > 1;
                
                prevBtn.disabled = !hasPrev;
                nextBtn.disabled = !hasNext;
            }

            applyFilters() {
                const status = document.getElementById('status-filter').value;
                const minPrice = document.getElementById('min-price').value;
                const maxPrice = document.getElementById('max-price').value;

                this.currentFilters = {
                    status: status || null,
                    minPrice: minPrice ? parseFloat(minPrice) : null,
                    maxPrice: maxPrice ? parseFloat(maxPrice) : null
                };

                // Reset to first page
                this.currentPage = 1;
                this.loadListings();
            }

            clearFilters() {
                document.getElementById('status-filter').value = '';
                document.getElementById('min-price').value = '';
                document.getElementById('max-price').value = '';
                
                this.currentFilters = {};
                this.currentPage = 1;
                this.loadListings();
            }

            editListing(supplierId, flowerId) {
                alert(`Chức năng chỉnh sửa cho supplier ${supplierId}, flower ${flowerId} sẽ được thêm sau`);
            }

            viewDetails(supplierId, flowerId) {
                alert(`Chi tiết cho supplier ${supplierId}, flower ${flowerId} sẽ được thêm sau`);
            }

            showLoading(show) {
                document.getElementById('loading').style.display = show ? 'block' : 'none';
            }

            showError(message) {
                const errorElement = document.getElementById('error-message');
                const errorContent = document.getElementById('error-content');
                errorContent.textContent = message;
                errorElement.style.display = 'block';
            }

            hideMessages() {
                document.getElementById('error-message').style.display = 'none';
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.listingManager = new ListingManager();
        });
    </script>
</body>
</html>
