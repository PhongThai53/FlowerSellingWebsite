<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Danh Sách Hoa</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/supplier.css" />
    <style>
      .header-actions {
        display: flex;
        gap: 15px;
        align-items: center;
        margin-bottom: 20px;
      }

      .search-section {
        margin: 20px 0;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #dee2e6;
      }

      .search-form {
        width: 100%;
      }

      .search-row {
        display: flex;
        gap: 15px;
        align-items: end;
        flex-wrap: wrap;
      }

      .search-field {
        display: flex;
        flex-direction: column;
        min-width: 200px;
      }

      .search-field label {
        margin-bottom: 5px;
        font-weight: 600;
        color: #333;
      }

      .search-field select,
      .search-field input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        text-decoration: none;
        display: inline-block;
        text-align: center;
      }

      .btn-primary {
        background-color: #007bff;
        color: white;
      }

      .btn-primary:hover {
        background-color: #0056b3;
      }

      .btn-secondary {
        background-color: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background-color: #545b62;
      }

      .btn-success {
        background-color: #28a745;
        color: white;
      }

      .btn-success:hover {
        background-color: #218838;
        transform: translateY(-1px);
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .error-message {
        background-color: #f8d7da;
        color: #721c24;
        padding: 15px;
        border: 1px solid #f5c6cb;
        border-radius: 4px;
        margin: 20px 0;
      }

      .flowers-list {
        margin: 20px 0;
      }

      .flower-item {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .flower-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .flower-name {
        font-size: 18px;
        font-weight: 600;
        color: #333;
      }

      .flower-actions {
        display: flex;
        gap: 10px;
      }

      .flower-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
      }

      .detail-item {
        display: flex;
        flex-direction: column;
      }

      .detail-label {
        font-weight: 600;
        color: #666;
        font-size: 12px;
        text-transform: uppercase;
        margin-bottom: 5px;
      }

      .detail-value {
        color: #333;
        font-size: 14px;
      }

      .flower-description {
        color: #666;
        font-style: italic;
        margin-top: 10px;
      }

      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
        margin: 30px 0;
      }

      .page-info {
        font-weight: 600;
        color: #333;
      }

      .no-results {
        text-align: center;
        padding: 40px;
        color: #666;
        font-style: italic;
      }

      .search-results-info {
        background: #e9ecef;
        padding: 15px;
        border-radius: 4px;
        margin: 20px 0;
        border-left: 4px solid #007bff;
      }

      .search-results-info p {
        margin: 5px 0;
        color: #495057;
      }

      .search-results-info span {
        font-weight: 600;
        color: #007bff;
      }

      .btn-sm {
        padding: 4px 8px;
        font-size: 12px;
      }

      .btn-outline-secondary {
        background-color: transparent;
        color: #6c757d;
        border: 1px solid #6c757d;
      }

      .btn-outline-secondary:hover {
        background-color: #6c757d;
        color: white;
      }
    </style>
  </head>
  <body>
    <div id="header-placeholder"></div>

    <div class="supplier-container">
      <h2>Danh Sách Hoa</h2>
      <div class="header-actions">
        <a href="add-flower.html" class="btn btn-primary">Thêm Hoa Mới</a>
        <a href="view-listing.html" class="btn btn-secondary">Xem Kho Hàng</a>
      </div>

      <!-- Search Form -->
      <div class="search-section">
        <form id="search-form" class="search-form">
          <div class="search-row">
            <div class="search-field">
              <label for="search-by">Tìm kiếm theo:</label>
              <select id="search-by" name="searchBy">
                <option value="">-- Chọn tiêu chí --</option>
                <option value="category">Danh mục</option>
                <option value="size">Kích thước</option>
                <option value="type">Loại hoa</option>
                <option value="color">Màu sắc</option>
              </select>
            </div>
            <div class="search-field">
              <label for="search-value">Giá trị tìm kiếm:</label>
              <input
                type="text"
                id="search-value"
                name="searchValue"
                placeholder="Nhập từ khóa tìm kiếm..."
              />
            </div>
            <div class="search-field">
              <button type="submit" class="btn btn-primary">Tìm kiếm</button>
              <button type="button" id="reset-search" class="btn btn-secondary">
                Làm mới
              </button>
            </div>
          </div>
        </form>
      </div>

      <!-- Loading Indicator -->
      <div id="loading" class="loading" style="display: none">
        <div class="spinner"></div>
        <p>Đang tải dữ liệu...</p>
      </div>

      <!-- Error Message -->
      <div id="error-message" class="error-message" style="display: none"></div>

      <!-- Search Results Info -->
      <div
        id="search-results-info"
        class="search-results-info"
        style="display: none"
      >
        <p>
          <strong>Kết quả tìm kiếm:</strong>
          <span id="results-count">0</span> hoa
        </p>
        <p>
          <strong>Tiêu chí tìm kiếm:</strong> <span id="search-criteria"></span>
        </p>
        <button
          id="clear-search-results"
          class="btn btn-sm btn-outline-secondary"
        >
          Xóa kết quả tìm kiếm
        </button>
      </div>

      <!-- Flowers List -->
      <div id="flowers-list" class="flowers-list">
        <!-- Flowers will be loaded here -->
      </div>

      <!-- Pagination -->
      <div id="pagination" class="pagination" style="display: none">
        <button id="prev-page" class="btn btn-secondary">Trang trước</button>
        <span id="page-info">Trang 1</span>
        <button id="next-page" class="btn btn-secondary">Trang tiếp</button>
      </div>
    </div>
    <script>
      fetch("../supplier/header.html")
        .then((response) => response.text())
        .then((data) => {
          document.getElementById("header-placeholder").innerHTML = data;
        });
    </script>

         <!-- Supplier Authentication Check -->
     <script src="../../js/auth.js"></script>
     <script src="../../js/supplier-auth-check.js"></script>
     <script src="../../js/supplier-logout.js"></script>

    <script>
      class FlowerListManager {
          constructor() {
              this.currentPage = 1;
              this.pageSize = 100;
              this.currentSearchBy = '';
              this.currentSearchValue = '';
              this.totalItems = 0;
              this.apiBaseUrl = 'http://localhost:5062/api';

              this.init();
          }

          init() {
              this.setupEventListeners();
              this.loadFlowers();
          }

          setupEventListeners() {
              // Search form submission
              document.getElementById('search-form').addEventListener('submit', (e) => {
                  e.preventDefault();

                  const searchBy = document.getElementById('search-by').value;
                  const searchValue = document.getElementById('search-value').value.trim();

                                  // Validate search input
              if (searchBy && !searchValue) {
                  alert('Vui lòng nhập giá trị tìm kiếm');
                  return;
              }

              // Show search info
              if (searchBy && searchValue) {
                  console.log(`Searching by: ${searchBy} = "${searchValue}"`);
              }

                  this.currentPage = 1;
                  this.currentSearchBy = searchBy;
                  this.currentSearchValue = searchValue;
                  this.loadFlowers();
              });

              // Reset search
              document.getElementById('reset-search').addEventListener('click', () => {
                  this.resetSearch();
              });

              // Clear search results
              document.getElementById('clear-search-results').addEventListener('click', () => {
                  this.resetSearch();
              });

              // Pagination
              document.getElementById('prev-page').addEventListener('click', () => {
                  if (this.currentPage > 1) {
                      this.currentPage--;
                      this.loadFlowers();
                  }
              });

              document.getElementById('next-page').addEventListener('click', () => {
                  const maxPage = Math.ceil(this.totalItems / this.pageSize);
                  if (this.currentPage < maxPage) {
                      this.currentPage++;
                      this.loadFlowers();
                  }
              });


          }

          async loadFlowers() {
              try {
                  this.showLoading(true);
                  this.hideError();

                  // Get current user info to get supplier ID
                  let supplierId = null;
                  if (window.authManager && window.authManager.getCurrentUser()) {
                      const currentUser = window.authManager.getCurrentUser();
                      if (currentUser.supplierId) {
                          supplierId = currentUser.supplierId;
                      }
                  }

                  const requestBody = {
                      page_index: this.currentPage,
                      page_size: this.pageSize
                  };

                  // Add search parameters if they exist
                  if (this.currentSearchBy && this.currentSearchValue) {
                      requestBody.search_by = this.currentSearchBy;
                      requestBody.search_value = this.currentSearchValue;
                  }

                  console.log('Request Body:', requestBody);

                  // Use supplier ID from user or default to 1 for testing
                  const url = supplierId
                      ? `${this.apiBaseUrl}/flower/list?supplerId=${supplierId}`
                      : `${this.apiBaseUrl}/flower/list?supplerId=1`;

                  const response = await fetch(url, {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json',
                      },
                      body: JSON.stringify(requestBody)
                  });

                  if (!response.ok) {
                      throw new Error(`HTTP error! status: ${response.status}`);
                  }

                  const data = await response.json();
                  console.log('API Response:', data);

                  // Handle different possible response structures
                  let flowers = [];
                  let totalItems = 0;

                  if (data.items && Array.isArray(data.items)) {
                      // Direct structure: { items: [...], total_items: ... }
                      flowers = data.items;
                      totalItems = data.total_items || 0;
                  } else if (data.data && data.data.items && Array.isArray(data.data.items)) {
                      // Wrapped structure: { data: { items: [...], totalItems: ... } }
                      flowers = data.data.items;
                      totalItems = data.data.totalItems || 0;
                  } else if (data.succeeded && data.data && Array.isArray(data.data)) {
                      // Another possible structure
                      flowers = data.data;
                      totalItems = data.totalItems || data.total_items || 0;
                  }

                  console.log('Extracted flowers:', flowers);
                  console.log('Total items:', totalItems);



                  this.totalItems = totalItems;
                  this.displayFlowers(flowers);
                  this.updatePagination();

              } catch (error) {
                  console.error('Error loading flowers:', error);
                  this.showError(`Lỗi khi tải dữ liệu: ${error.message}`);
              } finally {
                  this.showLoading(false);
              }
          }

          displayFlowers(flowers) {
              console.log('Displaying flowers:', flowers);

              const flowersListElement = document.getElementById('flowers-list');
              const searchResultsInfo = document.getElementById('search-results-info');
              const resultsCount = document.getElementById('results-count');
              const searchCriteria = document.getElementById('search-criteria');

              // Update search results info
              resultsCount.textContent = flowers.length;

              if (this.currentSearchBy && this.currentSearchValue) {
                  const searchByText = {
                      'category': 'Danh mục',
                      'size': 'Kích thước',
                      'type': 'Loại hoa',
                      'color': 'Màu sắc'
                  }[this.currentSearchBy] || this.currentSearchBy;

                  searchCriteria.textContent = `${searchByText}: "${this.currentSearchValue}"`;
                  searchResultsInfo.style.display = 'block';

                  // Show search info in console for debugging
                  console.log(`Search applied: ${this.currentSearchBy} = "${this.currentSearchValue}"`);
                  console.log(`Found ${flowers.length} results`);

                  // Show user-friendly message
                  if (flowers.length === 0) {
                      flowersListElement.innerHTML = `
                          <div class="no-results">
                              <p>Không tìm thấy hoa nào phù hợp với tiêu chí tìm kiếm</p>
                              <p><strong>Tiêu chí:</strong> ${searchByText}: "${this.currentSearchValue}"</p>
                              <button onclick="this.resetSearch()" class="btn btn-primary">Xóa tìm kiếm</button>
                          </div>
                      `;
                      return;
                  }
              } else {
                  searchResultsInfo.style.display = 'none';
                  console.log('No search applied, showing all flowers');
              }

              if (!flowers || flowers.length === 0) {
                  console.log('No flowers to display');
                  flowersListElement.innerHTML = '<div class="no-results">Không tìm thấy hoa nào</div>';
                  return;
              }

              console.log('Creating HTML for', flowers.length, 'flowers');
              const flowersHTML = flowers.map(flower => this.createFlowerHTML(flower)).join('');
              console.log('Generated HTML:', flowersHTML);

              flowersListElement.innerHTML = flowersHTML;
              console.log('Flowers list element updated');
          }

          createFlowerHTML(flower) {
              return `
                  <div class="flower-item">
                      <div class="flower-header">
                          <div class="flower-name">${flower.name || 'Không có tên'}</div>
                          <div class="flower-actions">
                              <button class="btn btn-success" onclick="flowerListManager.addToInventory(${flower.id || flower.Id || flower.ID})">
                                  <i class="ri-add-line"></i> Thêm vào kho
                              </button>
                              <button class="btn btn-primary" onclick="alert('Chức năng chỉnh sửa sẽ được thêm sau')">Chỉnh sửa</button>
                              <button class="btn btn-secondary" onclick="alert('Chức năng xem chi tiết sẽ được thêm sau')">Xem chi tiết</button>
                          </div>
                      </div>

                      <div class="flower-details">
                          <div class="detail-item">
                              <span class="detail-label">Danh mục</span>
                              <span class="detail-value">${flower.flowerCategory?.categoryName || 'Không có'}</span>
                          </div>
                          <div class="detail-item">
                              <span class="detail-label">Loại hoa</span>
                              <span class="detail-value">${flower.flowerType?.typeName || 'Không có'}</span>
                          </div>
                          <div class="detail-item">
                              <span class="detail-label">Màu sắc</span>
                              <span class="detail-value">${flower.flowerColor?.colorName || 'Không có'}</span>
                          </div>
                          <div class="detail-item">
                              <span class="detail-label">Kích thước</span>
                              <span class="detail-value">${flower.size || 'Không có'}</span>
                          </div>
                          <div class="detail-item">
                              <span class="detail-label">Thời hạn sử dụng</span>
                              <span class="detail-value">${flower.shelfLifeDays || 0} ngày</span>
                          </div>
                      </div>

                      ${flower.description ? `<div class="flower-description">${flower.description}</div>` : ''}
                  </div>
              `;
          }

          updatePagination() {
              const paginationElement = document.getElementById('pagination');
              const prevButton = document.getElementById('prev-page');
              const nextButton = document.getElementById('next-page');
              const pageInfo = document.getElementById('page-info');

              const maxPage = Math.ceil(this.totalItems / this.pageSize);

              if (maxPage <= 1) {
                  paginationElement.style.display = 'none';
                  return;
              }

              paginationElement.style.display = 'flex';
              pageInfo.textContent = `Trang ${this.currentPage} / ${maxPage}`;

              prevButton.disabled = this.currentPage <= 1;
              nextButton.disabled = this.currentPage >= maxPage;
          }

          resetSearch() {
              document.getElementById('search-by').value = '';
              document.getElementById('search-value').value = '';
              this.currentSearchBy = '';
              this.currentSearchValue = '';
              this.currentPage = 1;
              this.loadFlowers();
          }

          showLoading(show) {
              const loadingElement = document.getElementById('loading');
              const flowersListElement = document.getElementById('flowers-list');

              if (show) {
                  loadingElement.style.display = 'block';
                  flowersListElement.style.display = 'none';
              } else {
                  loadingElement.style.display = 'none';
                  flowersListElement.style.display = 'block';
              }
          }

          showError(message) {
              const errorElement = document.getElementById('error-message');
              const flowersListElement = document.getElementById('flowers-list');

              errorElement.textContent = message;
              errorElement.style.display = 'block';
          }

          async addToInventory(flowerId) {
              try {
                  // Hiển thị modal để nhập thông tin kho
                  const modal = this.createInventoryModal(flowerId);
                  document.body.appendChild(modal);

                  // Hiển thị modal
                  modal.style.display = 'block';
              } catch (error) {
                  console.error('Error opening inventory modal:', error);
                  this.showError('Lỗi khi mở form thêm vào kho: ' + error.message);
              }
          }

          createInventoryModal(flowerId) {
              const modal = document.createElement('div');
              modal.className = 'modal';
              modal.style.cssText = `
                  position: fixed;
                  top: 0;
                  left: 0;
                  width: 100%;
                  height: 100%;
                  background-color: rgba(0,0,0,0.5);
                  display: none;
                  z-index: 1000;
              `;

              modal.innerHTML = `
                  <div class="modal-content" style="
                      background-color: white;
                      margin: 5% auto;
                      padding: 20px;
                      border-radius: 8px;
                      width: 90%;
                      max-width: 500px;
                      position: relative;
                  ">
                      <span class="close" style="
                          position: absolute;
                          right: 20px;
                          top: 20px;
                          font-size: 28px;
                          font-weight: bold;
                          cursor: pointer;
                      ">&times;</span>

                      <h3>Thêm hoa vào kho</h3>
                      <form id="inventory-form">
                          <input type="hidden" id="flower-id" value="${flowerId}">

                          <div class="form-group">
                              <label for="available-quantity">Số lượng có sẵn *</label>
                              <input type="number" id="available-quantity" required min="1" value="1">
                          </div>

                          <div class="form-group">
                              <label for="unit-price">Giá đơn vị (VND) *</label>
                              <input type="number" id="unit-price" required min="1000" step="1000" value="50000">
                          </div>

                          <div class="form-group">
                              <label for="shelf-life-days">Thời hạn sử dụng (ngày) *</label>
                              <input type="number" id="shelf-life-days" required min="1" max="30" value="7">
                          </div>

                          <div class="form-group">
                              <label for="min-order-qty">Số lượng đặt hàng tối thiểu *</label>
                              <input type="number" id="min-order-qty" required min="1" value="1">
                          </div>

                          <div class="form-actions">
                              <button type="submit" class="btn btn-primary">Thêm vào kho</button>
                              <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Hủy</button>
                          </div>
                      </form>
                  </div>
              `;

              // Thêm CSS cho modal
              const style = document.createElement('style');
              style.textContent = `
                  .modal .form-group {
                      margin-bottom: 15px;
                  }
                  .modal .form-group label {
                      display: block;
                      margin-bottom: 5px;
                      font-weight: 600;
                  }
                  .modal .form-group input {
                      width: 100%;
                      padding: 8px;
                      border: 1px solid #ddd;
                      border-radius: 4px;
                  }
                  .modal .form-actions {
                      margin-top: 20px;
                      text-align: right;
                  }
                  .modal .form-actions button {
                      margin-left: 10px;
                  }
              `;
              document.head.appendChild(style);

              // Xử lý đóng modal
              const closeBtn = modal.querySelector('.close');
              closeBtn.onclick = () => modal.remove();

              // Xử lý submit form
              const form = modal.querySelector('#inventory-form');
              form.onsubmit = async (e) => {
                  e.preventDefault();
                  await this.submitInventoryForm(flowerId, modal);
              };

              return modal;
          }

          async submitInventoryForm(flowerId, modal) {
              try {
                  const formData = {
                      supplierId: 1, // Default for testing, should get from user session
                      flowerId: flowerId,
                      availableQuantity: parseInt(document.getElementById('available-quantity').value),
                      unitPrice: parseFloat(document.getElementById('unit-price').value),
                      shelfLifeDays: parseInt(document.getElementById('shelf-life-days').value),
                      minOrderQty: parseInt(document.getElementById('min-order-qty').value),
                      status: "Pending"
                  };

                  console.log('Submitting inventory data:', formData);

                                      // Lấy JWT token từ localStorage
                    let headers = {
                        'Content-Type': 'application/json',
                    };
                    const token = localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token');
                    if (token) {
                        headers['Authorization'] = `Bearer ${token}`;
                    }

                    const response = await fetch(`${this.apiBaseUrl}/SupplierListing/create`, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(formData)
                    });

                  if (response.ok) {
                      const result = await response.json();
                      alert('Thêm hoa vào kho thành công!');
                      modal.remove();
                      // Refresh danh sách hoa
                      this.loadFlowers();
                  } else {
                      const errorData = await response.json();
                      throw new Error(errorData.message || 'Lỗi khi thêm vào kho');
                  }
              } catch (error) {
                  console.error('Error submitting inventory form:', error);
                  alert('Lỗi khi thêm vào kho: ' + error.message);
              }
          }


          hideError() {
              document.getElementById('error-message').style.display = 'none';
          }


      }

              // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.flowerListManager = new FlowerListManager();
        });
    </script>
  </body>
</html>
