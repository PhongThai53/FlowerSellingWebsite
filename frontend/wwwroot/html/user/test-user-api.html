<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test User Management APIs</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        .response-container {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        .json-response {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .status-success {
            color: #198754;
        }
        .status-error {
            color: #dc3545;
        }
        .btn-test {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">
            <i class="fa fa-cog"></i> Test User Management APIs
        </h1>

        <!-- Authentication Status -->
        <div class="test-section">
            <h3>Authentication Status</h3>
            <div id="auth-status" class="mb-3">Checking...</div>
            <button class="btn btn-primary btn-test" onclick="testAuth()">
                <i class="fa fa-check"></i> Check Authentication
            </button>
        </div>

        <!-- Test Get Users List -->
        <div class="test-section">
            <h3>1. Get Users List (POST /api/user/list)</h3>
            <div class="row mb-3">
                <div class="col-md-3">
                    <label>Page:</label>
                    <input type="number" id="list-page" class="form-control" value="1" min="1">
                </div>
                <div class="col-md-3">
                    <label>Page Size:</label>
                    <input type="number" id="list-pagesize" class="form-control" value="10" min="1" max="100">
                </div>
                <div class="col-md-3">
                    <label>Search:</label>
                    <input type="text" id="list-search" class="form-control" placeholder="Search term">
                </div>
                <div class="col-md-3">
                    <label>Role Filter:</label>
                    <select id="list-role" class="form-control">
                        <option value="">All Roles</option>
                        <option value="Admin">Admin</option>
                        <option value="User">User</option>
                        <option value="Users">Users</option>
                        <option value="Staff">Staff</option>
                        <option value="Supplier">Supplier</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-primary btn-test" onclick="testGetUsersList()">
                <i class="fa fa-list"></i> Test Get Users List
            </button>
            <div id="users-list-response" class="response-container" style="display: none;"></div>
        </div>

        <!-- Test Get User by ID -->
        <div class="test-section">
            <h3>2. Get User by ID (GET /api/user/{id})</h3>
            <div class="mb-3">
                <label>User ID (GUID):</label>
                <input type="text" id="get-user-id" class="form-control" placeholder="Enter user GUID">
                <small class="text-muted">Get a user ID from the users list above</small>
            </div>
            <button class="btn btn-primary btn-test" onclick="testGetUserById()">
                <i class="fa fa-user"></i> Test Get User by ID
            </button>
            <div id="get-user-response" class="response-container" style="display: none;"></div>
        </div>

        <!-- Test Create User -->
        <div class="test-section">
            <h3>3. Create User (POST /api/user)</h3>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label>Full Name:</label>
                    <input type="text" id="create-fullname" class="form-control" value="Test User">
                </div>
                <div class="col-md-6">
                    <label>Email:</label>
                    <input type="email" id="create-email" class="form-control" value="testuser@example.com">
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label>Password:</label>
                    <input type="password" id="create-password" class="form-control" value="password123">
                </div>
                <div class="col-md-6">
                    <label>Phone:</label>
                    <input type="text" id="create-phone" class="form-control" value="0123456789">
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label>Role:</label>
                    <select id="create-role" class="form-control">
                        <option value="User">User</option>
                        <option value="Admin">Admin</option>
                        <option value="Staff">Staff</option>
                        <option value="Supplier">Supplier</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label>Address:</label>
                    <input type="text" id="create-address" class="form-control" value="Test Address">
                </div>
            </div>
            <button class="btn btn-success btn-test" onclick="testCreateUser()">
                <i class="fa fa-plus"></i> Test Create User
            </button>
            <div id="create-user-response" class="response-container" style="display: none;"></div>
        </div>

        <!-- Test Update User -->
        <div class="test-section">
            <h3>4. Update User (PATCH /api/user/{id})</h3>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label>User ID to Update:</label>
                    <input type="text" id="update-user-id" class="form-control" placeholder="Enter user GUID">
                </div>
                <div class="col-md-6">
                    <label>Full Name:</label>
                    <input type="text" id="update-fullname" class="form-control" value="Updated Test User">
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label>Phone:</label>
                    <input type="text" id="update-phone" class="form-control" value="0987654321">
                </div>
                <div class="col-md-6">
                    <label>Role:</label>
                    <select id="update-role" class="form-control">
                        <option value="User">User</option>
                        <option value="Admin">Admin</option>
                        <option value="Staff">Staff</option>
                        <option value="Supplier">Supplier</option>
                    </select>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label>Address:</label>
                    <input type="text" id="update-address" class="form-control" value="Updated Address">
                </div>
                <div class="col-md-6">
                    <label>Is Active:</label>
                    <select id="update-active" class="form-control">
                        <option value="true">Active</option>
                        <option value="false">Inactive</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-warning btn-test" onclick="testUpdateUser()">
                <i class="fa fa-edit"></i> Test Update User
            </button>
            <div id="update-user-response" class="response-container" style="display: none;"></div>
        </div>

        <!-- Test Delete User -->
        <div class="test-section">
            <h3>5. Delete User (DELETE /api/user/{id})</h3>
            <div class="mb-3">
                <label>User ID to Delete:</label>
                <input type="text" id="delete-user-id" class="form-control" placeholder="Enter user GUID">
                <small class="text-danger">Warning: This will permanently delete the user!</small>
            </div>
            <button class="btn btn-danger btn-test" onclick="testDeleteUser()">
                <i class="fa fa-trash"></i> Test Delete User
            </button>
            <div id="delete-user-response" class="response-container" style="display: none;"></div>
        </div>

        <!-- Test Get Roles -->
        <div class="test-section">
            <h3>6. Get Roles (GET /api/user/roles)</h3>
            <p>Test API endpoint để lấy danh sách roles có sẵn trong hệ thống.</p>
            <button class="btn btn-info btn-test" onclick="testGetRoles()">
                <i class="fa fa-users-cog"></i> Test Get Roles
            </button>
            <div id="get-roles-response" class="response-container" style="display: none;"></div>
        </div>

        <!-- API Response Container -->
        <div class="test-section">
            <h3>Latest API Response</h3>
            <div id="latest-response" class="response-container">
                <div class="text-muted">No API calls made yet</div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../../js/auth.js"></script>
    
    <script>
        const API_BASE_URL = 'http://localhost:5062/api';

        // Test authentication status
        function testAuth() {
            const authStatus = document.getElementById('auth-status');
            
            if (window.authManager) {
                const isAuth = window.authManager.isAuthenticated();
                const user = window.authManager.getCurrentUser();
                const token = window.authManager.getAuthToken();
                
                authStatus.innerHTML = `
                    <div class="alert ${isAuth ? 'alert-success' : 'alert-danger'}">
                        <strong>Authentication:</strong> ${isAuth ? 'Authenticated' : 'Not authenticated'}<br>
                        <strong>User:</strong> ${user ? JSON.stringify(user, null, 2) : 'None'}<br>
                        <strong>Token:</strong> ${token ? 'Present' : 'None'}
                    </div>
                `;
            } else {
                authStatus.innerHTML = `
                    <div class="alert alert-danger">
                        AuthManager not available
                    </div>
                `;
            }
        }

        // Make authenticated request
        async function makeAuthenticatedRequest(url, options = {}) {
            const token = window.authManager?.getAuthToken();
            if (!token) {
                throw new Error('No authentication token available');
            }

            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
            };

            const mergedOptions = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers,
                },
            };

            return fetch(url, mergedOptions);
        }

        // Display response
        function displayResponse(containerId, response, data, error = null) {
            const container = document.getElementById(containerId);
            const latestContainer = document.getElementById('latest-response');
            
            let statusClass = response?.ok ? 'status-success' : 'status-error';
            let statusText = response ? `${response.status} ${response.statusText}` : 'Network Error';
            
            if (error) {
                statusClass = 'status-error';
                statusText = 'Error: ' + error.message;
            }

            const responseHTML = `
                <div class="mb-2">
                    <strong class="${statusClass}">Status:</strong> ${statusText}
                </div>
                <div class="json-response">${JSON.stringify(data || error, null, 2)}</div>
            `;

            container.innerHTML = responseHTML;
            container.style.display = 'block';
            
            latestContainer.innerHTML = responseHTML;
        }

        // Test get users list
        async function testGetUsersList() {
            try {
                const queryParams = {
                    page_index: parseInt(document.getElementById('list-page').value),
                    page_size: parseInt(document.getElementById('list-pagesize').value),
                    sort_by: 'fullname',
                    sort_direction: 0 // Asc
                };

                const search = document.getElementById('list-search').value;
                if (search) {
                    queryParams.search_by = 'fullname';
                    queryParams.search_value = search;
                }

                const role = document.getElementById('list-role').value;
                if (role) {
                    queryParams.filers = { role: role };
                }

                const response = await makeAuthenticatedRequest(`${API_BASE_URL}/user/list`, {
                    method: 'POST',
                    body: JSON.stringify(queryParams)
                });

                const data = await response.json();
                displayResponse('users-list-response', response, data);

                // Auto-fill first user ID for other tests
                if (data.items && data.items.length > 0) {
                    const firstUser = data.items[0];
                    document.getElementById('get-user-id').value = firstUser.publicId;
                    document.getElementById('update-user-id').value = firstUser.publicId;
                    document.getElementById('delete-user-id').value = firstUser.publicId;
                }

            } catch (error) {
                displayResponse('users-list-response', null, null, error);
            }
        }

        // Test get user by ID
        async function testGetUserById() {
            try {
                const userId = document.getElementById('get-user-id').value;
                if (!userId) {
                    alert('Please enter a user ID');
                    return;
                }

                const response = await makeAuthenticatedRequest(`${API_BASE_URL}/user/${userId}`);
                const data = await response.json();
                displayResponse('get-user-response', response, data);

            } catch (error) {
                displayResponse('get-user-response', null, null, error);
            }
        }

        // Test create user
        async function testCreateUser() {
            try {
                const userData = {
                    fullName: document.getElementById('create-fullname').value,
                    email: document.getElementById('create-email').value,
                    password: document.getElementById('create-password').value,
                    phoneNumber: document.getElementById('create-phone').value,
                    address: document.getElementById('create-address').value,
                    roleName: document.getElementById('create-role').value
                };

                const response = await makeAuthenticatedRequest(`${API_BASE_URL}/user`, {
                    method: 'POST',
                    body: JSON.stringify(userData)
                });

                const data = await response.json();
                displayResponse('create-user-response', response, data);

                // If successful, add the new user ID to other test fields
                if (response.ok && data.publicId) {
                    document.getElementById('get-user-id').value = data.publicId;
                    document.getElementById('update-user-id').value = data.publicId;
                    document.getElementById('delete-user-id').value = data.publicId;
                }

            } catch (error) {
                displayResponse('create-user-response', null, null, error);
            }
        }

        // Test update user
        async function testUpdateUser() {
            try {
                const userId = document.getElementById('update-user-id').value;
                if (!userId) {
                    alert('Please enter a user ID');
                    return;
                }

                const updateData = {
                    fullName: document.getElementById('update-fullname').value,
                    phoneNumber: document.getElementById('update-phone').value,
                    address: document.getElementById('update-address').value,
                    roleName: document.getElementById('update-role').value,
                    isActive: document.getElementById('update-active').value === 'true'
                };

                const response = await makeAuthenticatedRequest(`${API_BASE_URL}/user/${userId}`, {
                    method: 'PATCH',
                    body: JSON.stringify(updateData)
                });

                const data = await response.json();
                displayResponse('update-user-response', response, data);

            } catch (error) {
                displayResponse('update-user-response', null, null, error);
            }
        }

        // Test delete user
        async function testDeleteUser() {
            try {
                const userId = document.getElementById('delete-user-id').value;
                if (!userId) {
                    alert('Please enter a user ID');
                    return;
                }

                if (!confirm('Are you sure you want to delete this user? This action cannot be undone!')) {
                    return;
                }

                const response = await makeAuthenticatedRequest(`${API_BASE_URL}/user/${userId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                displayResponse('delete-user-response', response, data);

            } catch (error) {
                displayResponse('delete-user-response', null, null, error);
            }
        }

        // Test get roles
        async function testGetRoles() {
            try {
                const response = await makeAuthenticatedRequest(`${API_BASE_URL}/user/roles`);
                const data = await response.json();
                displayResponse('get-roles-response', response, data);

                // Auto-populate role options in create form
                if (response.ok && data && Array.isArray(data)) {
                    const createRoleSelect = document.getElementById('create-role');
                    const updateRoleSelect = document.getElementById('update-role');
                    
                    if (createRoleSelect) {
                        // Preserve current value
                        const currentValue = createRoleSelect.value;
                        createRoleSelect.innerHTML = '';
                        
                        data.forEach(role => {
                            const option = document.createElement('option');
                            option.value = role.roleName;
                            option.textContent = `${role.roleName}${role.description ? ` - ${role.description}` : ''}`;
                            if (role.roleName === currentValue) {
                                option.selected = true;
                            }
                            createRoleSelect.appendChild(option);
                        });
                    }
                    
                    if (updateRoleSelect) {
                        // Preserve current value
                        const currentValue = updateRoleSelect.value;
                        updateRoleSelect.innerHTML = '';
                        
                        data.forEach(role => {
                            const option = document.createElement('option');
                            option.value = role.roleName;
                            option.textContent = `${role.roleName}${role.description ? ` - ${role.description}` : ''}`;
                            if (role.roleName === currentValue) {
                                option.selected = true;
                            }
                            updateRoleSelect.appendChild(option);
                        });
                    }
                }

            } catch (error) {
                displayResponse('get-roles-response', null, null, error);
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            testAuth();
        });
    </script>
</body>
</html>
