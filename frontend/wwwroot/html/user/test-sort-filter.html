<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Sort & Filter - User Management</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .response-container {
            background: #ffffff;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }
        .json-response {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .status-success {
            color: #198754;
            font-weight: bold;
        }
        .status-error {
            color: #dc3545;
            font-weight: bold;
        }
        .btn-test {
            margin: 5px;
            min-width: 120px;
        }
        .filter-form {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .result-summary {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            border-left: 4px solid #2196f3;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">
            <i class="fa fa-filter"></i> Test Sort & Filter Functions
        </h1>

        <!-- Authentication Check -->
        <div class="test-section">
            <h3>Authentication Status</h3>
            <div id="auth-status" class="mb-3">Checking...</div>
            <button class="btn btn-primary btn-test" onclick="checkAuth()">
                <i class="fa fa-refresh"></i> Check Auth
            </button>
            <button class="btn btn-success btn-test" onclick="simulateAdminLogin()">
                <i class="fa fa-user-shield"></i> Login as Admin
            </button>
        </div>

        <!-- Filter Test Form -->
        <div class="test-section">
            <h3>Test Filters & Sort</h3>
            <div class="filter-form">
                <div class="row">
                    <!-- Search -->
                    <div class="col-md-6 mb-3">
                        <label>Search:</label>
                        <input type="text" id="test-search" class="form-control" placeholder="Search by name, email, phone">
                    </div>
                    
                    <!-- Role Filter -->
                    <div class="col-md-6 mb-3">
                        <label>Role Filter:</label>
                        <select id="test-role" class="form-control">
                            <option value="">All Roles</option>
                            <option value="Admin">Admin</option>
                            <option value="User">User</option>
                            <option value="Users">Users</option>
                            <option value="Staff">Staff</option>
                            <option value="Supplier">Supplier</option>
                        </select>
                    </div>
                </div>
                
                <div class="row">
                    <!-- Sort By -->
                    <div class="col-md-6 mb-3">
                        <label>Sort By:</label>
                        <select id="test-sortby" class="form-control">
                            <option value="fullname">Full Name</option>
                            <option value="email">Email</option>
                            <option value="createdat" selected>Created Date</option>
                            <option value="username">Username</option>
                        </select>
                    </div>
                    
                    <!-- Sort Direction -->
                    <div class="col-md-6 mb-3">
                        <label>Sort Direction:</label>
                        <select id="test-sortdir" class="form-control">
                            <option value="Asc">Ascending</option>
                            <option value="Desc" selected>Descending</option>
                        </select>
                    </div>
                </div>
                
                <div class="row">
                    <!-- Page Controls -->
                    <div class="col-md-6 mb-3">
                        <label>Page:</label>
                        <input type="number" id="test-page" class="form-control" value="1" min="1">
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label>Page Size:</label>
                        <select id="test-pagesize" class="form-control">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                        </select>
                    </div>
                </div>
                
                <div class="text-center">
                    <button class="btn btn-primary btn-test" onclick="testUserList()">
                        <i class="fa fa-search"></i> Test User List
                    </button>
                    <button class="btn btn-secondary btn-test" onclick="clearTestFilters()">
                        <i class="fa fa-times"></i> Clear Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Quick Test Buttons -->
        <div class="test-section">
            <h3>Quick Tests</h3>
            <div class="row">
                <div class="col-md-6">
                    <h5>Search Tests:</h5>
                    <button class="btn btn-info btn-test" onclick="quickTest('search', 'admin')">
                        Search "admin"
                    </button>
                    <button class="btn btn-info btn-test" onclick="quickTest('search', 'user')">
                        Search "user"
                    </button>
                    <button class="btn btn-info btn-test" onclick="quickTest('search', '@gmail')">
                        Search "@gmail"
                    </button>
                </div>
                
                <div class="col-md-6">
                    <h5>Filter Tests:</h5>
                    <button class="btn btn-warning btn-test" onclick="quickTest('role', 'Admin')">
                        Filter: Admin
                    </button>
                    <button class="btn btn-warning btn-test" onclick="quickTest('role', 'User')">
                        Filter: User
                    </button>

                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-12">
                    <h5>Sort Tests:</h5>
                    <button class="btn btn-success btn-test" onclick="quickTest('sort', 'fullname,Asc')">
                        Sort: Name A-Z
                    </button>
                    <button class="btn btn-success btn-test" onclick="quickTest('sort', 'fullname,Desc')">
                        Sort: Name Z-A
                    </button>
                    <button class="btn btn-success btn-test" onclick="quickTest('sort', 'email,Asc')">
                        Sort: Email A-Z
                    </button>
                    <button class="btn btn-success btn-test" onclick="quickTest('sort', 'createdat,Desc')">
                        Sort: Newest First
                    </button>
                </div>
            </div>
        </div>

        <!-- Response Display -->
        <div class="test-section">
            <h3>API Response</h3>
            <div id="response-container" class="response-container">
                <div class="text-muted">No API calls made yet. Click a test button above.</div>
            </div>
            
            <div id="result-summary" class="result-summary" style="display: none;">
                <!-- Summary will be populated here -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../../js/auth.js"></script>
    
    <script>
        const API_BASE_URL = 'http://localhost:5062/api';

        // Check authentication
        function checkAuth() {
            const authStatus = document.getElementById('auth-status');
            
            if (window.authManager) {
                const isAuth = window.authManager.isAuthenticated();
                const user = window.authManager.getCurrentUser();
                
                authStatus.innerHTML = `
                    <div class="alert ${isAuth ? 'alert-success' : 'alert-warning'}">
                        <strong>Authentication:</strong> ${isAuth ? 'Authenticated' : 'Not authenticated'}<br>
                        ${user ? `<strong>User:</strong> ${user.fullName} (${user.roleName})<br>` : ''}
                        <strong>Token:</strong> ${window.authManager.getAuthToken() ? 'Present' : 'None'}
                    </div>
                `;
            } else {
                authStatus.innerHTML = `
                    <div class="alert alert-danger">
                        AuthManager not available
                    </div>
                `;
            }
        }

        // Simulate admin login
        function simulateAdminLogin() {
            if (window.authManager) {
                const adminUser = {
                    id: 1,
                    publicId: '12345678-1234-1234-1234-123456789012',
                    fullName: 'Test Admin',
                    email: 'admin@test.com',
                    roleName: 'Admin',
                    isActive: true
                };
                
                window.authManager.user = adminUser;
                window.authManager.token = 'fake-admin-token';
                
                localStorage.setItem('user_data', JSON.stringify(adminUser));
                localStorage.setItem('auth_token', 'fake-admin-token');
                
                checkAuth();
                alert('Admin login simulated!');
            }
        }

        // Make authenticated request
        async function makeAuthenticatedRequest(url, options = {}) {
            const token = window.authManager?.getAuthToken();
            if (!token) {
                throw new Error('No authentication token available');
            }

            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
            };

            const mergedOptions = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers,
                },
            };

            return fetch(url, mergedOptions);
        }

        // Build query parameters
        function buildQueryParams() {
            const params = {
                page_index: parseInt(document.getElementById('test-page').value) || 1,
                page_size: parseInt(document.getElementById('test-pagesize').value) || 10,
                sort_by: document.getElementById('test-sortby').value || 'createdat',
                sort_direction: document.getElementById('test-sortdir').value === 'Desc' ? 1 : 0,
            };

            // Add search
            const search = document.getElementById('test-search').value.trim();
            if (search) {
                params.search_by = 'fullname';
                params.search_value = search;
            }

            // Add filters
            const filterParams = {};
            const role = document.getElementById('test-role').value;

            if (role) filterParams.role = role;

            if (Object.keys(filterParams).length > 0) {
                params.filers = filterParams; // Note: backend typo
            }

            return params;
        }

        // Display response
        function displayResponse(response, data, error = null) {
            const container = document.getElementById('response-container');
            const summaryContainer = document.getElementById('result-summary');
            
            let statusClass = response?.ok ? 'status-success' : 'status-error';
            let statusText = response ? `${response.status} ${response.statusText}` : 'Network Error';
            
            if (error) {
                statusClass = 'status-error';
                statusText = 'Error: ' + error.message;
            }

            const responseHTML = `
                <div class="mb-2">
                    <strong class="${statusClass}">Status:</strong> ${statusText}
                </div>
                <div class="json-response">${JSON.stringify(data || error, null, 2)}</div>
            `;

            container.innerHTML = responseHTML;

            // Show summary if successful
            if (response?.ok && data) {
                summaryContainer.style.display = 'block';
                summaryContainer.innerHTML = `
                    <h5><i class="fa fa-chart-bar"></i> Result Summary</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Total Items:</strong> ${data.total_items || 0}
                        </div>
                        <div class="col-md-3">
                            <strong>Total Pages:</strong> ${data.total_pages || 0}
                        </div>
                        <div class="col-md-3">
                            <strong>Current Page:</strong> ${data.page || 0}
                        </div>
                        <div class="col-md-3">
                            <strong>Items Returned:</strong> ${data.items?.length || 0}
                        </div>
                    </div>
                    ${data.items && data.items.length > 0 ? `
                        <div class="mt-3">
                            <strong>Sample Users:</strong>
                            <ul class="list-unstyled mt-2">
                                ${data.items.slice(0, 3).map(user => `
                                    <li><i class="fa fa-user"></i> ${user.fullName} (${user.email}) - ${user.roleName} - ${user.isActive ? 'Active' : 'Inactive'}</li>
                                `).join('')}
                                ${data.items.length > 3 ? `<li><em>... and ${data.items.length - 3} more</em></li>` : ''}
                            </ul>
                        </div>
                    ` : ''}
                `;
            } else {
                summaryContainer.style.display = 'none';
            }
        }

        // Test user list
        async function testUserList() {
            try {
                const queryParams = buildQueryParams();
                console.log('Testing with params:', queryParams);

                const response = await makeAuthenticatedRequest(`${API_BASE_URL}/user/list`, {
                    method: 'POST',
                    body: JSON.stringify(queryParams)
                });

                const data = await response.json();
                displayResponse(response, data);

            } catch (error) {
                console.error('Test error:', error);
                displayResponse(null, null, error);
            }
        }

        // Quick test functions
        function quickTest(type, value) {
            // Clear all filters first
            clearTestFilters();

            // Set specific test
            switch (type) {
                case 'search':
                    document.getElementById('test-search').value = value;
                    break;
                case 'role':
                    document.getElementById('test-role').value = value;
                    break;
                case 'sort':
                    const [sortBy, sortDir] = value.split(',');
                    document.getElementById('test-sortby').value = sortBy;
                    document.getElementById('test-sortdir').value = sortDir;
                    break;
            }

            // Run test
            testUserList();
        }

        // Clear test filters
        function clearTestFilters() {
            document.getElementById('test-search').value = '';
            document.getElementById('test-role').value = '';
            document.getElementById('test-sortby').value = 'createdat';
            document.getElementById('test-sortdir').value = 'Desc';
            document.getElementById('test-page').value = '1';
            document.getElementById('test-pagesize').value = '10';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
        });
    </script>
</body>
</html>
