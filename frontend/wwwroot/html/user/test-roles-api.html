<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Roles API - User Management</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .response-container {
            background: #ffffff;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }
        .json-response {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .status-success {
            color: #198754;
            font-weight: bold;
        }
        .status-error {
            color: #dc3545;
            font-weight: bold;
        }
        .btn-test {
            margin: 5px;
            min-width: 120px;
        }
        .role-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            transition: all 0.2s ease;
        }
        .role-card:hover {
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0,123,255,0.15);
        }
        .role-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 8px;
        }
        .role-admin { background: #dc3545; color: white; }
        .role-user { background: #28a745; color: white; }
        .role-staff { background: #ffc107; color: #212529; }
        .role-supplier { background: #17a2b8; color: white; }
        .role-guest { background: #6c757d; color: white; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">
            <i class="fa fa-users-cog"></i> Test Roles API & Role Display
        </h1>

        <!-- Authentication Check -->
        <div class="test-section">
            <h3>Authentication Status</h3>
            <div id="auth-status" class="mb-3">Checking...</div>
            <button class="btn btn-primary btn-test" onclick="checkAuth()">
                <i class="fa fa-refresh"></i> Check Auth
            </button>
            <button class="btn btn-success btn-test" onclick="simulateAdminLogin()">
                <i class="fa fa-user-shield"></i> Login as Admin
            </button>
        </div>

        <!-- Test Get Roles API -->
        <div class="test-section">
            <h3>Test GET /api/user/roles</h3>
            <p>Test API endpoint để lấy danh sách roles từ database.</p>
            <button class="btn btn-info btn-test" onclick="testGetRoles()">
                <i class="fa fa-download"></i> Get Roles from API
            </button>
            <div id="roles-response" class="response-container" style="display: none;"></div>
            
            <!-- Display Roles Cards -->
            <div id="roles-cards" class="mt-3" style="display: none;">
                <h5>Roles Available:</h5>
                <div id="roles-list"></div>
            </div>
        </div>

        <!-- Test Role Filter -->
        <div class="test-section">
            <h3>Test Role Filter & Display</h3>
            <p>Test role dropdown và role display trong user cards.</p>
            
            <div class="row">
                <div class="col-md-6">
                    <label>Select Role Filter:</label>
                    <select id="role-filter-test" class="form-control">
                        <option value="">Loading roles...</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-primary btn-test" onclick="testRoleFilter()">
                        <i class="fa fa-filter"></i> Test Filter by Role
                    </button>
                </div>
            </div>
            
            <div id="filter-response" class="response-container" style="display: none;"></div>
        </div>

        <!-- Test Role Display -->
        <div class="test-section">
            <h3>Test Role Display in User Cards</h3>
            <p>Test hiển thị role badges trong user cards với màu sắc phù hợp.</p>
            
            <div class="row">
                <div class="col-md-12">
                    <h6>Preview Role Badges:</h6>
                    <div id="role-badges-preview">
                        <span class="role-badge role-admin">Admin</span>
                        <span class="role-badge role-user">User</span>
                        <span class="role-badge role-staff">Staff</span>
                        <span class="role-badge role-supplier">Supplier</span>
                        <span class="role-badge role-guest">Guest</span>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-success btn-test" onclick="testUserCards()">
                <i class="fa fa-users"></i> Test User Cards with Roles
            </button>
            <div id="user-cards-response" class="response-container" style="display: none;"></div>
        </div>

        <!-- Test Role Mapping -->
        <div class="test-section">
            <h3>Test Role Display Names</h3>
            <p>Test mapping từ role name sang display name tiếng Việt.</p>
            
            <div id="role-mapping-test">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Role Name (API)</th>
                            <th>Display Name (Tiếng Việt)</th>
                            <th>CSS Class</th>
                            <th>Preview</th>
                        </tr>
                    </thead>
                    <tbody id="role-mapping-table">
                        <tr>
                            <td colspan="4">Click "Test Role Mapping" to see results</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <button class="btn btn-warning btn-test" onclick="testRoleMapping()">
                <i class="fa fa-language"></i> Test Role Mapping
            </button>
        </div>

        <!-- Latest Response -->
        <div class="test-section">
            <h3>Latest API Response</h3>
            <div id="latest-response" class="response-container">
                <div class="text-muted">No API calls made yet</div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../../js/auth.js"></script>
    
    <script>
        const API_BASE_URL = 'http://localhost:5062/api';
        let availableRoles = [];

        // Check authentication
        function checkAuth() {
            const authStatus = document.getElementById('auth-status');
            
            if (window.authManager) {
                const isAuth = window.authManager.isAuthenticated();
                const user = window.authManager.getCurrentUser();
                
                authStatus.innerHTML = `
                    <div class="alert ${isAuth ? 'alert-success' : 'alert-warning'}">
                        <strong>Authentication:</strong> ${isAuth ? 'Authenticated' : 'Not authenticated'}<br>
                        ${user ? `<strong>User:</strong> ${user.fullName} (${user.roleName})<br>` : ''}
                        <strong>Token:</strong> ${window.authManager.getAuthToken() ? 'Present' : 'None'}
                    </div>
                `;
            } else {
                authStatus.innerHTML = `
                    <div class="alert alert-danger">
                        AuthManager not available
                    </div>
                `;
            }
        }

        // Simulate admin login
        function simulateAdminLogin() {
            if (window.authManager) {
                const adminUser = {
                    id: 1,
                    publicId: '12345678-1234-1234-1234-123456789012',
                    fullName: 'Test Admin',
                    email: 'admin@test.com',
                    roleName: 'Admin'
                };
                
                window.authManager.user = adminUser;
                window.authManager.token = 'fake-admin-token';
                
                localStorage.setItem('user_data', JSON.stringify(adminUser));
                localStorage.setItem('auth_token', 'fake-admin-token');
                
                checkAuth();
                alert('Admin login simulated!');
            }
        }

        // Make authenticated request
        async function makeAuthenticatedRequest(url, options = {}) {
            const token = window.authManager?.getAuthToken();
            if (!token) {
                throw new Error('No authentication token available');
            }

            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
            };

            const mergedOptions = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers,
                },
            };

            return fetch(url, mergedOptions);
        }

        // Display response
        function displayResponse(containerId, response, data, error = null) {
            const container = document.getElementById(containerId);
            const latestContainer = document.getElementById('latest-response');
            
            let statusClass = response?.ok ? 'status-success' : 'status-error';
            let statusText = response ? `${response.status} ${response.statusText}` : 'Network Error';
            
            if (error) {
                statusClass = 'status-error';
                statusText = 'Error: ' + error.message;
            }

            const responseHTML = `
                <div class="mb-2">
                    <strong class="${statusClass}">Status:</strong> ${statusText}
                </div>
                <div class="json-response">${JSON.stringify(data || error, null, 2)}</div>
            `;

            container.innerHTML = responseHTML;
            container.style.display = 'block';
            
            latestContainer.innerHTML = responseHTML;
        }

        // Test get roles
        async function testGetRoles() {
            try {
                const response = await makeAuthenticatedRequest(`${API_BASE_URL}/user/roles`);
                const data = await response.json();
                displayResponse('roles-response', response, data);

                if (response.ok && data && Array.isArray(data)) {
                    availableRoles = data;
                    displayRolesCards(data);
                    populateRoleFilter(data);
                }

            } catch (error) {
                displayResponse('roles-response', null, null, error);
            }
        }

        // Display roles as cards
        function displayRolesCards(roles) {
            const container = document.getElementById('roles-cards');
            const rolesList = document.getElementById('roles-list');
            
            const rolesHTML = roles.map(role => `
                <div class="role-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="role-badge ${getRoleClass(role.roleName)}">${role.roleName}</span>
                            <strong>${getRoleDisplayName(role.roleName)}</strong>
                        </div>
                        <div class="text-muted">
                            <small>ID: ${role.id}</small>
                            ${role.description ? `<br><small>${role.description}</small>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            
            rolesList.innerHTML = rolesHTML;
            container.style.display = 'block';
        }

        // Populate role filter
        function populateRoleFilter(roles) {
            const select = document.getElementById('role-filter-test');
            select.innerHTML = '<option value="">Tất cả vai trò</option>';
            
            roles.forEach(role => {
                const option = document.createElement('option');
                option.value = role.roleName;
                option.textContent = getRoleDisplayName(role.roleName);
                select.appendChild(option);
            });
        }

        // Test role filter
        async function testRoleFilter() {
            try {
                const selectedRole = document.getElementById('role-filter-test').value;
                
                const queryParams = {
                    page_index: 1,
                    page_size: 10,
                    sort_by: 'fullname',
                    sort_direction: 0
                };

                if (selectedRole) {
                    queryParams.filers = { role: selectedRole };
                }

                const response = await makeAuthenticatedRequest(`${API_BASE_URL}/user/list`, {
                    method: 'POST',
                    body: JSON.stringify(queryParams)
                });

                const data = await response.json();
                displayResponse('filter-response', response, data);

            } catch (error) {
                displayResponse('filter-response', null, null, error);
            }
        }

        // Test user cards
        async function testUserCards() {
            try {
                const response = await makeAuthenticatedRequest(`${API_BASE_URL}/user/list`, {
                    method: 'POST',
                    body: JSON.stringify({
                        page_index: 1,
                        page_size: 5,
                        sort_by: 'fullname',
                        sort_direction: 0
                    })
                });

                const data = await response.json();
                displayResponse('user-cards-response', response, data);

                // Display user cards preview
                if (response.ok && data.items) {
                    const cardsHTML = data.items.map(user => `
                        <div class="role-card">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                        ${getInitials(user.fullName)}
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <strong>${user.fullName}</strong><br>
                                    <span class="role-badge ${getRoleClass(user.roleName)}">${user.roleName}</span>
                                    <small class="text-muted">${user.email}</small>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    document.getElementById('user-cards-response').innerHTML += `
                        <div class="mt-3">
                            <h6>User Cards Preview:</h6>
                            ${cardsHTML}
                        </div>
                    `;
                }

            } catch (error) {
                displayResponse('user-cards-response', null, null, error);
            }
        }

        // Test role mapping
        function testRoleMapping() {
            const testRoles = ['Admin', 'User', 'Users', 'Staff', 'Supplier', 'Guest', 'Moderator'];
            const tableBody = document.getElementById('role-mapping-table');
            
            const mappingHTML = testRoles.map(roleName => `
                <tr>
                    <td><code>${roleName}</code></td>
                    <td>${getRoleDisplayName(roleName)}</td>
                    <td><code>${getRoleClass(roleName)}</code></td>
                    <td><span class="role-badge ${getRoleClass(roleName)}">${roleName}</span></td>
                </tr>
            `).join('');
            
            tableBody.innerHTML = mappingHTML;
        }

        // Helper functions
        function getRoleDisplayName(roleName) {
            const roleDisplayNames = {
                'Admin': 'Quản trị viên',
                'User': 'Người dùng',
                'Users': 'Người dùng',
                'Staff': 'Nhân viên',
                'Supplier': 'Nhà cung cấp',
                'Moderator': 'Kiểm duyệt viên',
                'Guest': 'Khách'
            };
            return roleDisplayNames[roleName] || roleName;
        }

        function getRoleClass(roleName) {
            switch (roleName?.toLowerCase()) {
                case 'admin': return 'role-admin';
                case 'user': 
                case 'users': return 'role-user';
                case 'staff': return 'role-staff';
                case 'supplier': return 'role-supplier';
                case 'guest': return 'role-guest';
                default: return 'role-user';
            }
        }

        function getInitials(fullName) {
            if (!fullName) return 'U';
            const names = fullName.trim().split(' ');
            if (names.length === 1) return names[0][0].toUpperCase();
            return (names[0][0] + names[names.length - 1][0]).toUpperCase();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
        });
    </script>
</body>
</html>
