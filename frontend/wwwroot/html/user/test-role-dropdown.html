<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Role Dropdown - User Management</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        .debug-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .debug-log {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">
            <i class="fa fa-bug"></i> Debug Role Dropdown
        </h1>

        <!-- Auth Status -->
        <div class="debug-section">
            <h3>1. Authentication Status</h3>
            <div id="auth-status">Loading...</div>
            <button class="btn btn-primary" onclick="simulateLogin()">
                <i class="fa fa-sign-in-alt"></i> Simulate Admin Login
            </button>
        </div>

        <!-- Role Filter Dropdown -->
        <div class="debug-section">
            <h3>2. Role Filter Dropdown Test</h3>
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">Role Filter:</label>
                    <select id="role-filter" class="form-control">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="col-md-8">
                    <button class="btn btn-info" onclick="testLoadRoles()">
                        <i class="fa fa-download"></i> Load Roles
                    </button>
                    <button class="btn btn-success" onclick="checkDropdownState()">
                        <i class="fa fa-search"></i> Check Dropdown
                    </button>
                </div>
            </div>
        </div>

        <!-- User Form Role Dropdown -->
        <div class="debug-section">
            <h3>3. User Form Role Dropdown Test</h3>
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">User Role:</label>
                    <select id="roleName" class="form-control">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="col-md-8">
                    <button class="btn btn-warning" onclick="testFormRoles()">
                        <i class="fa fa-form"></i> Populate Form Roles
                    </button>
                </div>
            </div>
        </div>

        <!-- API Test -->
        <div class="debug-section">
            <h3>4. Direct API Test</h3>
            <button class="btn btn-danger" onclick="testDirectAPI()">
                <i class="fa fa-globe"></i> Test /api/user/roles
            </button>
            <div id="api-response" class="mt-3" style="display: none;">
                <h6>API Response:</h6>
                <div id="api-content" class="debug-log"></div>
            </div>
        </div>

        <!-- User List Test -->
        <div class="debug-section">
            <h3>5. User List API Test</h3>
            <button class="btn btn-success" onclick="testUserListAPI()">
                <i class="fa fa-users"></i> Test /api/user/list
            </button>
            <div id="userlist-response" class="mt-3" style="display: none;">
                <h6>User List Response:</h6>
                <div id="userlist-content" class="debug-log"></div>
            </div>
        </div>

        <!-- Debug Log -->
        <div class="debug-section">
            <h3>6. Debug Log</h3>
            <button class="btn btn-secondary" onclick="clearLog()">
                <i class="fa fa-trash"></i> Clear Log
            </button>
            <div id="debug-log" class="debug-log mt-3">Ready...\n</div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../../js/auth.js"></script>
    <script src="../../js/user-manager.js"></script>
    
    <script>
        // Override console.log to capture to our debug log
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        const debugLog = document.getElementById('debug-log');
        
        function addToLog(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f00' : type === 'warn' ? '#ff0' : '#0f0';
            debugLog.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            debugLog.scrollTop = debugLog.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToLog(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToLog('ERROR: ' + args.join(' '), 'error');
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToLog('WARN: ' + args.join(' '), 'warn');
        };

        // Clear log function
        function clearLog() {
            debugLog.innerHTML = 'Log cleared...\n';
        }

        // Check auth status
        function checkAuthStatus() {
            const authStatus = document.getElementById('auth-status');
            
            if (window.authManager) {
                const isAuth = window.authManager.isAuthenticated();
                const user = window.authManager.getCurrentUser();
                const token = window.authManager.getAuthToken();
                
                console.log('Auth check:', { isAuth, user, hasToken: !!token });
                
                authStatus.innerHTML = `
                    <div class="alert ${isAuth ? 'alert-success' : 'alert-warning'}">
                        <strong>Authenticated:</strong> ${isAuth}<br>
                        <strong>User:</strong> ${user ? `${user.fullName} (${user.roleName})` : 'None'}<br>
                        <strong>Token:</strong> ${token ? 'Present' : 'Missing'}
                    </div>
                `;
            } else {
                console.error('AuthManager not available');
                authStatus.innerHTML = `
                    <div class="alert alert-danger">
                        AuthManager not available
                    </div>
                `;
            }
        }

        // Simulate login
        function simulateLogin() {
            console.log('Simulating admin login...');
            
            if (window.authManager) {
                const adminUser = {
                    id: 1,
                    publicId: '12345678-1234-1234-1234-123456789012',
                    fullName: 'Test Admin',
                    email: 'admin@test.com',
                    roleName: 'Admin'
                };
                
                window.authManager.user = adminUser;
                window.authManager.token = 'fake-admin-token';
                
                localStorage.setItem('user_data', JSON.stringify(adminUser));
                localStorage.setItem('auth_token', 'fake-admin-token');
                
                console.log('Admin login simulated successfully');
                checkAuthStatus();
            }
        }

        // Test load roles
        async function testLoadRoles() {
            console.log('Testing role loading...');
            
            if (window.userManager) {
                try {
                    await window.userManager.loadAvailableRoles();
                    console.log('loadAvailableRoles completed');
                    console.log('Available roles:', window.userManager.availableRoles);
                } catch (error) {
                    console.error('Error in loadAvailableRoles:', error);
                }
            } else {
                console.error('UserManager not available');
            }
        }

        // Check dropdown state
        function checkDropdownState() {
            const roleFilter = document.getElementById('role-filter');
            const roleName = document.getElementById('roleName');
            
            console.log('Dropdown states:');
            console.log('role-filter options:', roleFilter.innerHTML);
            console.log('roleName options:', roleName.innerHTML);
        }

        // Test form roles
        async function testFormRoles() {
            console.log('Testing form role population...');
            
            // Manually populate roles for testing
            const roleSelect = document.getElementById('roleName');
            const roleFilter = document.getElementById('role-filter');
            
            const testRoles = [
                { value: 'Admin', label: 'Quản trị viên' },
                { value: 'User', label: 'Người dùng' },
                { value: 'Staff', label: 'Nhân viên' },
                { value: 'Supplier', label: 'Nhà cung cấp' }
            ];
            
            // Populate role filter
            roleFilter.innerHTML = '<option value="">Tất cả vai trò</option>';
            testRoles.forEach(role => {
                roleFilter.innerHTML += `<option value="${role.value}">${role.label}</option>`;
            });
            
            // Populate role select
            roleSelect.innerHTML = '<option value="">Chọn vai trò</option>';
            testRoles.forEach(role => {
                roleSelect.innerHTML += `<option value="${role.value}">${role.label}</option>`;
            });
            
            console.log('Form roles populated manually');
        }

        // Test direct API
        async function testDirectAPI() {
            console.log('Testing direct API call...');
            
            try {
                const token = window.authManager?.getAuthToken();
                if (!token) {
                    console.error('No auth token available');
                    return;
                }
                
                const response = await fetch('http://localhost:5062/api/user/roles', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('API Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('API Response data:', data);
                    
                    document.getElementById('api-response').style.display = 'block';
                    document.getElementById('api-content').textContent = JSON.stringify(data, null, 2);
                } else {
                    const errorText = await response.text();
                    console.error('API Error:', errorText);
                    
                    document.getElementById('api-response').style.display = 'block';
                    document.getElementById('api-content').textContent = `Error ${response.status}: ${errorText}`;
                }
                
            } catch (error) {
                console.error('API Call failed:', error);
            }
        }

        // Test user list API
        async function testUserListAPI() {
            console.log('Testing user list API call...');
            
            try {
                const token = window.authManager?.getAuthToken();
                if (!token) {
                    console.error('No auth token available');
                    return;
                }
                
                const payload = {
                    page_index: 1,
                    page_size: 5,
                    sort_by: 'fullname',
                    sort_direction: 0
                };
                
                console.log('Sending payload:', payload);
                
                const response = await fetch('http://localhost:5062/api/user/list', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                console.log('User List API Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('User List API Response data:', data);
                    console.log('First user roleName:', data.items?.[0]?.roleName);
                    
                    document.getElementById('userlist-response').style.display = 'block';
                    document.getElementById('userlist-content').textContent = JSON.stringify(data, null, 2);
                } else {
                    const errorText = await response.text();
                    console.error('User List API Error:', errorText);
                    
                    document.getElementById('userlist-response').style.display = 'block';
                    document.getElementById('userlist-content').textContent = `Error ${response.status}: ${errorText}`;
                }
                
            } catch (error) {
                console.error('User List API Call failed:', error);
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, checking initial state...');
            checkAuthStatus();
        });
    </script>
</body>
</html>
