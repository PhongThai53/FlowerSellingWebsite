<!DOCTYPE html>
<html class="no-js" lang="zxx">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Test User Management Navigation" />
    <title>Test Navigation - User Management</title>

    <!--=== Favicon ===-->
    <link rel="shortcut icon" href="../../images/favicon.ico" type="image/x-icon" />

    <!-- Google fonts include -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,500,500i,700,900%7CYesteryear" rel="stylesheet" />

    <!-- All Vendor & plugins CSS include -->
    <link href="../../css/vendor.css" rel="stylesheet" />
    <!-- Main Style CSS -->
    <link href="../../css/style.css" rel="stylesheet" />
    <!-- Custom CSS for auth pages -->
    <link href="../../css/auth.css" rel="stylesheet" />

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10" integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLSi8nO7UC" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/htmx.org/dist/ext/json-enc.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Linearicons -->
    <link rel="stylesheet" href="https://cdn.linearicons.com/free/1.0.0/icon-font.min.css" />

    <style>
        .test-container {
            padding: 40px 0;
            min-height: 60vh;
        }
        .test-section {
            background: #f8f9fa;
            padding: 30px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .test-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }
        .auth-status {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .btn-test {
            margin: 10px;
            padding: 10px 20px;
        }
        .code-block {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #666;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .warning {
            color: #ffc107;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <!-- Load Header Component -->
    <div hx-get="../components/header.html" hx-trigger="load" hx-swap="outerHTML"></div>

    <!-- Main Content -->
    <main class="main-wrapper">
        <div class="container test-container">
            <h1 class="text-center mb-4">Test User Management Navigation</h1>

            <div class="test-info">
                <h4><i class="fa fa-info-circle"></i> Hướng dẫn test</h4>
                <p>Trang này giúp test xem navigation "Quản lý người dùng" có hiển thị đúng không dựa trên role của user.</p>
                <ul>
                    <li><strong>Admin:</strong> Sẽ thấy menu "Quản lý người dùng" trong navigation và user dropdown</li>
                    <li><strong>User/Other roles:</strong> Không thấy menu "Quản lý người dùng"</li>
                    <li><strong>Not logged in:</strong> Không thấy menu "Quản lý người dùng"</li>
                </ul>
            </div>

            <!-- Authentication Status -->
            <div class="test-section">
                <h3><i class="fa fa-user-shield"></i> Authentication Status</h3>
                <div id="auth-status" class="auth-status">
                    Checking authentication status...
                </div>
                <button class="btn btn-primary btn-test" onclick="checkAuthStatus()">
                    <i class="fa fa-refresh"></i> Check Auth Status
                </button>
                <button class="btn btn-info btn-test" onclick="simulateAdminLogin()">
                    <i class="fa fa-user-cog"></i> Simulate Admin Login
                </button>
                <button class="btn btn-warning btn-test" onclick="simulateUserLogin()">
                    <i class="fa fa-user"></i> Simulate User Login
                </button>
                <button class="btn btn-secondary btn-test" onclick="clearAuth()">
                    <i class="fa fa-sign-out-alt"></i> Clear Auth
                </button>
            </div>

            <!-- Navigation Test -->
            <div class="test-section">
                <h3><i class="fa fa-bars"></i> Navigation Test</h3>
                <div id="nav-test-results">
                    <p>Click "Test Navigation" để kiểm tra navigation menu...</p>
                </div>
                <button class="btn btn-success btn-test" onclick="testNavigation()">
                    <i class="fa fa-search"></i> Test Navigation
                </button>
            </div>

            <!-- User Dropdown Test -->
            <div class="test-section">
                <h3><i class="fa fa-user-circle"></i> User Dropdown Test</h3>
                <div id="dropdown-test-results">
                    <p>Click "Test User Dropdown" để kiểm tra user dropdown menu...</p>
                </div>
                <button class="btn btn-success btn-test" onclick="testUserDropdown()">
                    <i class="fa fa-search"></i> Test User Dropdown
                </button>
            </div>

            <!-- Quick Links -->
            <div class="test-section">
                <h3><i class="fa fa-link"></i> Quick Links to User Management</h3>
                <div class="d-flex flex-wrap">
                    <a href="user-list.html" class="btn btn-primary btn-test">
                        <i class="fa fa-users"></i> User List
                    </a>
                    <a href="user-detail.html" class="btn btn-success btn-test">
                        <i class="fa fa-user-plus"></i> Create User
                    </a>
                    <a href="test-user-api.html" class="btn btn-info btn-test">
                        <i class="fa fa-cogs"></i> API Test
                    </a>
                </div>
            </div>
        </div>
    </main>

    <!-- Load Footer Component -->
    <div hx-get="../components/footer.html" hx-trigger="load" hx-swap="outerHTML"></div>

    <!-- Scripts -->
    <script src="../../js/vendor.js"></script>
    <script src="../../js/active.js"></script>
    <script src="../../js/auth.js"></script>

    <script>
        // Check authentication status
        function checkAuthStatus() {
            const authStatus = document.getElementById('auth-status');
            
            if (window.authManager) {
                const isAuth = window.authManager.isAuthenticated();
                const user = window.authManager.getCurrentUser();
                const token = window.authManager.getAuthToken();
                
                let statusHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Authentication Status</h5>
                            <p class="${isAuth ? 'success' : 'error'}">
                                <i class="fa fa-${isAuth ? 'check-circle' : 'times-circle'}"></i>
                                ${isAuth ? 'Authenticated' : 'Not authenticated'}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h5>Token Status</h5>
                            <p class="${token ? 'success' : 'error'}">
                                <i class="fa fa-${token ? 'key' : 'lock'}"></i>
                                ${token ? 'Token present' : 'No token'}
                            </p>
                        </div>
                    </div>
                `;
                
                if (user) {
                    statusHTML += `
                        <div class="row mt-3">
                            <div class="col-12">
                                <h5>User Information</h5>
                                <div class="code-block">
                                    <strong>Full Name:</strong> ${user.fullName || 'N/A'}<br>
                                    <strong>Email:</strong> ${user.email || 'N/A'}<br>
                                    <strong>Role:</strong> <span class="${user.roleName === 'Admin' ? 'success' : 'warning'}">${user.roleName || 'N/A'}</span><br>
                                    <strong>Active:</strong> ${user.isActive ? 'Yes' : 'No'}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                authStatus.innerHTML = statusHTML;
            } else {
                authStatus.innerHTML = `
                    <div class="error">
                        <i class="fa fa-exclamation-triangle"></i>
                        AuthManager not available
                    </div>
                `;
            }
        }

        // Simulate admin login
        function simulateAdminLogin() {
            if (window.authManager) {
                const adminUser = {
                    id: 1,
                    publicId: '12345678-1234-1234-1234-123456789012',
                    fullName: 'Admin User',
                    email: 'admin@example.com',
                    roleName: 'Admin',
                    isActive: true
                };
                
                window.authManager.user = adminUser;
                window.authManager.token = 'fake-admin-token';
                
                // Save to localStorage
                localStorage.setItem('user_data', JSON.stringify(adminUser));
                localStorage.setItem('auth_token', 'fake-admin-token');
                
                // Update UI
                window.authManager.updateUserInterface();
                checkAuthStatus();
                
                alert('Simulated Admin login! Check the navigation menu.');
            }
        }

        // Simulate user login
        function simulateUserLogin() {
            if (window.authManager) {
                const regularUser = {
                    id: 2,
                    publicId: '87654321-4321-4321-4321-210987654321',
                    fullName: 'Regular User',
                    email: 'user@example.com',
                    roleName: 'User',
                    isActive: true
                };
                
                window.authManager.user = regularUser;
                window.authManager.token = 'fake-user-token';
                
                // Save to localStorage
                localStorage.setItem('user_data', JSON.stringify(regularUser));
                localStorage.setItem('auth_token', 'fake-user-token');
                
                // Update UI
                window.authManager.updateUserInterface();
                checkAuthStatus();
                
                alert('Simulated User login! Check the navigation menu (should not see User Management).');
            }
        }

        // Clear authentication
        function clearAuth() {
            if (window.authManager) {
                window.authManager.clearAuthData();
                checkAuthStatus();
                alert('Authentication cleared! Check the navigation menu.');
            }
        }

        // Test navigation
        function testNavigation() {
            const adminUserManagement = document.getElementById('admin-user-management');
            const resultsDiv = document.getElementById('nav-test-results');
            
            let results = '<h5>Navigation Test Results:</h5>';
            
            if (adminUserManagement) {
                const isVisible = adminUserManagement.style.display !== 'none';
                const currentUser = window.authManager?.getCurrentUser();
                const isAdmin = currentUser?.roleName === 'Admin';
                
                results += `
                    <div class="code-block">
                        <strong>User Management Menu Element:</strong> Found<br>
                        <strong>Visibility:</strong> <span class="${isVisible ? 'success' : 'warning'}">${isVisible ? 'Visible' : 'Hidden'}</span><br>
                        <strong>Current User Role:</strong> ${currentUser?.roleName || 'Not logged in'}<br>
                        <strong>Should be visible:</strong> ${isAdmin ? 'Yes (Admin)' : 'No (Not Admin)'}<br>
                        <strong>Test Result:</strong> <span class="${(isVisible && isAdmin) || (!isVisible && !isAdmin) ? 'success' : 'error'}">
                            ${(isVisible && isAdmin) || (!isVisible && !isAdmin) ? 'PASS' : 'FAIL'}
                        </span>
                    </div>
                `;
            } else {
                results += `
                    <div class="code-block error">
                        <strong>Error:</strong> User Management menu element not found in DOM
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = results;
        }

        // Test user dropdown
        function testUserDropdown() {
            const userDropdown = document.getElementById('user-dropdown');
            const resultsDiv = document.getElementById('dropdown-test-results');
            
            let results = '<h5>User Dropdown Test Results:</h5>';
            
            if (userDropdown) {
                const dropdownHTML = userDropdown.innerHTML;
                const hasUserManagement = dropdownHTML.includes('Quản lý người dùng');
                const currentUser = window.authManager?.getCurrentUser();
                const isAdmin = currentUser?.roleName === 'Admin';
                
                results += `
                    <div class="code-block">
                        <strong>User Dropdown Element:</strong> Found<br>
                        <strong>Contains User Management Link:</strong> <span class="${hasUserManagement ? 'success' : 'warning'}">${hasUserManagement ? 'Yes' : 'No'}</span><br>
                        <strong>Current User Role:</strong> ${currentUser?.roleName || 'Not logged in'}<br>
                        <strong>Should contain User Management:</strong> ${isAdmin ? 'Yes (Admin)' : 'No (Not Admin)'}<br>
                        <strong>Test Result:</strong> <span class="${(hasUserManagement && isAdmin) || (!hasUserManagement && !isAdmin) ? 'success' : 'error'}">
                            ${(hasUserManagement && isAdmin) || (!hasUserManagement && !isAdmin) ? 'PASS' : 'FAIL'}
                        </span>
                    </div>
                    <div class="mt-3">
                        <strong>Current Dropdown HTML:</strong>
                        <div class="code-block" style="font-size: 12px; max-height: 200px; overflow-y: auto;">
                            ${dropdownHTML || '<em>Empty</em>'}
                        </div>
                    </div>
                `;
            } else {
                results += `
                    <div class="code-block error">
                        <strong>Error:</strong> User dropdown element not found in DOM
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = results;
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Wait a bit for HTMX to load the header
            setTimeout(() => {
                checkAuthStatus();
            }, 1000);
        });
    </script>
</body>
</html>
