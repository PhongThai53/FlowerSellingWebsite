
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>POS Dash | Responsive Bootstrap 4 Admin Dashboard Template</title>

    <!-- Favicon -->
    <link rel="shortcut icon" href="../../images/logo/favicon.ico" />
    <link rel="stylesheet" href="../../css/backend-plugin.min.css">
    <link rel="stylesheet" href="../../css/backend.css?v=1.0.0">
    <link rel="stylesheet" href="../../css/@fortawesome/fontawesome-free/css/all.min.css">
    <link rel="stylesheet" href="../../css/line-awesome/dist/line-awesome/css/line-awesome.min.css">
    <link rel="stylesheet" href="../../css/remixicon/fonts/remixicon.css">
    <body class="  ">
        <!-- loader Start -->
        <div id="loading">
            <div id="loading-center">
            </div>
        </div>
        <!-- loader END -->
        <!-- Wrapper Start -->
        <div class="wrapper">

            <!-- Nav -->
            <div id="nav-placeholder"></div>

            <!-- Header -->
            <div id="header-placeholder"></div>


            <div class="modal fade" id="new-order" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-body">
                            <div class="popup text-left">
                                <h4 class="mb-3">New Order</h4>
                                <div class="content create-workform bg-body">
                                    <div class="pb-3">
                                        <label class="mb-2">Email</label>
                                        <input type="text" class="form-control" placeholder="Enter Name or Email">
                                    </div>
                                    <div class="col-lg-12 mt-4">
                                        <div class="d-flex flex-wrap align-items-ceter justify-content-center">
                                            <div class="btn btn-primary mr-4" data-dismiss="modal">Cancel</div>
                                            <div class="btn btn-outline-primary" data-dismiss="modal">Create</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>      <div class="content-page">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="d-flex flex-wrap flex-wrap align-items-center justify-content-between mb-4">
                                <a href="page-add-product.html" class="btn btn-primary add-list"><i class="las la-plus mr-3"></i>Add Product</a>
                            </div>
                        </div>
                        <div class="col-lg-12">
                            <div class="table-responsive rounded mb-3">

                                <!--Table data-->
                                <table id="productTable" class="table mb-0 tbl-server-info">
                                    <thead class="bg-white text-uppercase">
                                        <tr class="ligth ligth-data">
                                            <th>
                                                <div class="checkbox d-inline-block">
                                                    <input type="checkbox" class="checkbox-input" id="checkAll">
                                                    <label for="checkAll" class="mb-0"></label>
                                                </div>
                                            </th>
                                            <th id="sortName" style="cursor:pointer;">Product ⬍</th>
                                            <th id="sortId" style="cursor:pointer;">Code ⬍</th>
                                            <th>Category</th>
                                            <th id="sortPrice" style="cursor:pointer;">Price ⬍</th>
                                            <th>Quantity</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody class="ligth-body" id="tableBody">
                                        <!-- JS render rows -->
                                    </tbody>
                                </table>
                                <!-- Pagination -->

                                <nav aria-label="Page navigation">
                                    <ul style="padding-top:20px" class="pagination justify-content-center" id="pagination">
                                        <!-- JS render pagination buttons -->
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                    <!-- Page end  -->
                </div>
                <!-- Modal Edit -->
                <div class="modal fade" id="edit-note" tabindex="-1" role="dialog" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered" role="document">
                        <div class="modal-content">
                            <div class="modal-body">
                                <div class="popup text-left">
                                    <div class="media align-items-top justify-content-between">
                                        <h3 class="mb-3">Product</h3>
                                        <div class="btn-cancel p-0" data-dismiss="modal"><i class="las la-times"></i></div>
                                    </div>
                                    <div class="content edit-notes">
                                        <div class="card card-transparent card-block card-stretch event-note mb-0">
                                            <div class="card-body px-0 bukmark">
                                                <div class="d-flex align-items-center justify-content-between pb-2 mb-3 border-bottom">
                                                    <div class="quill-tool">
                                                    </div>
                                                </div>
                                                <div id="quill-toolbar1">
                                                    <p>Virtual Digital Marketing Course every week on Monday, Wednesday and Saturday.Virtual Digital Marketing Course every week on Monday</p>
                                                </div>
                                            </div>
                                            <div class="card-footer border-0">
                                                <div class="d-flex flex-wrap align-items-ceter justify-content-end">
                                                    <div class="btn btn-primary mr-3" data-dismiss="modal">Cancel</div>
                                                    <div class="btn btn-outline-primary" data-dismiss="modal">Save</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Wrapper End-->
        <footer class="iq-footer">
            <div class="container-fluid">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-lg-6">
                                <ul class="list-inline mb-0">
                                    <li class="list-inline-item"><a href="../backend/privacy-policy.html">Privacy Policy</a></li>
                                    <li class="list-inline-item"><a href="../backend/terms-of-service.html">Terms of Use</a></li>
                                </ul>
                            </div>
                            <div class="col-lg-6 text-right">
                                <span class="mr-1">
                                    <script>document.write(new Date().getFullYear())</script>©
                                </span> <a href="#" class="">POS Dash</a>.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
        <script>fetch('nav.html').then(response => response.text()).then(data => { document.getElementById('nav-placeholder').innerHTML = data; });</script>
        <script>fetch('header.html').then(response => response.text()).then(data => { document.getElementById('header-placeholder').innerHTML = data; });</script> <!--nav--> <!--header--> <!-- Backend Bundle JavaScript -->


        <script>
            const API_BASE = "https://localhost:7062/api";
            let products = [], currentSort = { key: null, asc: true }, currentPage = 1, totalPages = 1, pageSize = 10;

            const productImage = id => `${API_BASE.replace('/api', '')}/Image/products/${id}/primary.jpg`;

            async function loadProducts(pageNumber = 1, pageSizeParam = 10) {
                try {
                    currentPage = pageNumber; pageSize = pageSizeParam;
                    const url = `${API_BASE}/Product?pageNumber=${pageNumber}&pageSize=${pageSize}&categoryId=0&min=0&max=500000&asc=true`;
                    const res = await fetch(url), json = await res.json();
                    if (!json.succeeded) { console.error("API error:", json.message); return; }
                    products = json.data.items || [];
                    totalPages = json.data.totalPages ?? Math.ceil((json.data.totalCount ?? products.length) / pageSize);
                    renderTable(); renderPagination();
                } catch (e) { console.error("Fetch error:", e); }
            }

            function renderTable() {
                const tbody = document.getElementById("tableBody");
                tbody.innerHTML = "";
                products.forEach(p => {
                    const tr = document.createElement("tr");
                    const photoUrl = `${API_BASE.replace('/api', '')}${p.url}`;
                    tr.innerHTML = `
<td>
                          <div class="checkbox d-inline-block">
                            <input type="checkbox" class="checkbox-input row-check" id="checkbox_${p.id}">
                            <label for="checkbox_${p.id}" class="mb-0"></label>
                          </div>
</td>
<td>
                          <div class="d-flex align-items-center">
                            <img src="${photoUrl || productImage(p.id)}" class="img-fluid rounded avatar-50 mr-3" alt="image">
                            <div>${p.name}</div>
                          </div>
</td>
<td>PRD${p.id}</td>
<td>${p.categoryName || "-"}</td>
<td>${p.price ? p.price.toLocaleString() + "₫" : "-"}</td>
<td>${p.stock ?? 0}</td>
<td>
                          <div class="d-flex align-items-center list-action">
                            <a class="badge badge-info mr-2" data-toggle="tooltip" href="page-view-product.html?id=${p.id}" title="View"><i class="ri-eye-line mr-0"></i></a>
                            <a class="badge bg-success mr-2" data-toggle="tooltip" href="page-edit-product.html?id=${p.id}" title="Edit"><i class="ri-pencil-line mr-0"></i></a>
                            <a class="badge bg-warning mr-2 delete-btn" href="#" data-id="${p.id}" title="Delete"><i class="ri-delete-bin-line mr-0"></i></a>
                          </div>
</td>`;
                    tbody.appendChild(tr);
                });
            }

            function renderPagination() {
                const el = document.getElementById("pagination"); el.innerHTML = "";
                const makeLi = (html, disabled = false) => { const li = document.createElement("li"); li.className = "page-item" + (disabled ? " disabled" : ""); li.innerHTML = html; return li; };

                el.appendChild(makeLi(`<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>`, currentPage === 1));
                let startPage = Math.max(1, currentPage - 2), endPage = Math.min(totalPages, currentPage + 2);
                if (currentPage <= 3) endPage = Math.min(5, totalPages);
                if (currentPage > totalPages - 3) startPage = Math.max(1, totalPages - 4);

                if (startPage > 1) { el.appendChild(makeLi(`<a class="page-link" href="#" onclick="changePage(1)">1</a>`)); if (startPage > 2) el.appendChild(makeLi(`<span class="page-link">...</span>`, true)); }

                for (let i = startPage; i <= endPage; i++) {
                    const active = i === currentPage ? " active" : "";
                    const li = document.createElement("li"); li.className = `page-item${active}`; li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`; el.appendChild(li);
                }

                if (endPage < totalPages) { if (endPage < totalPages - 1) el.appendChild(makeLi(`<span class="page-link">...</span>`, true)); el.appendChild(makeLi(`<a class="page-link" href="#" onclick="changePage(${totalPages})">${totalPages}</a>`)); }

                el.appendChild(makeLi(`<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>`, currentPage === totalPages));
            }

            function changePage(page) { if (page < 1 || page > totalPages || page === currentPage) return; loadProducts(page, pageSize); }
            function changePageSize(newPageSize) { pageSize = newPageSize; currentPage = 1; loadProducts(1, pageSize); }

            function sortBy(key) {
                if (currentSort.key === key) currentSort.asc = !currentSort.asc; else currentSort = { key, asc: true };
                products.sort((a, b) => {
                    let A = a[key], B = b[key];
                    if (typeof A === "string") A = A.toLowerCase();
                    if (typeof B === "string") B = B.toLowerCase();
                    if (A < B) return currentSort.asc ? -1 : 1;
                    if (A > B) return currentSort.asc ? 1 : -1;
                    return 0;
                });
                renderTable();
            }

            document.getElementById("checkAll").addEventListener("change", function () { document.querySelectorAll(".row-check").forEach(cb => cb.checked = this.checked); });
            document.getElementById("sortId").addEventListener("click", () => sortBy("id"));
            document.getElementById("sortName").addEventListener("click", () => sortBy("name"));
            document.getElementById("sortPrice").addEventListener("click", () => sortBy("price"));

            document.getElementById("tableBody").addEventListener("click", e => {
                const del = e.target.closest(".delete-btn"); if (!del) return; e.preventDefault();
                const id = Number(del.dataset.id); if (!id) return; deleteProduct(id);
            });

            async function deleteProduct(id) {
                try {
                    if (!confirm("Bạn có chắc muốn xóa sản phẩm này không?")) return;
                    const res = await fetch(`${API_BASE}/Product/${id}`, { method: 'DELETE', headers: { 'Content-Type': 'application/json' } });
                    const text = await res.text();
                    let json = null;
                    try { json = JSON.parse(text); } catch (_) { }
                    if (!res.ok || (json && json.succeeded === false)) { alert("Xóa thất bại: " + ((json && json.message) || text || res.statusText)); return; }
                    await loadProducts(currentPage, pageSize);
                    if (currentPage > totalPages && totalPages > 0) { currentPage = totalPages; await loadProducts(currentPage, pageSize); }
                } catch (e) { console.error("Delete error:", e); alert("Có lỗi khi xóa sản phẩm."); }
            }

            document.addEventListener("DOMContentLoaded", () => loadProducts());


        </script>


        <script src="../../js/admin/backend-bundle.min.js"></script> <!-- Table Treeview JavaScript -->
        <script src="../../js/admin/table-treeview.js"></script> <!-- Chart Custom JavaScript -->
        <script src="../../js/admin/customizer.js"></script> <!-- Chart Custom JavaScript -->
        <script async src="../../js/admin/chart-custom.js"></script> <!-- app JavaScript -->
        <script src="../../js/admin/app.js"></script>

    </body>
</html>